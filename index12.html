
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduFlow Pro | Ultimate Assessment System</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #6366f1; --danger: #ef4444; --success: #10b981; --dark: #0f172a; --slate: #1e293b; --warn: #f59e0b; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--dark); color: white; line-height: 1.6; }
        
        .view-section { display: none; padding: 15px; max-width: 1200px; margin: 0 auto; box-sizing: border-box; }
        .active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--slate); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #334155; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; font-size: 16px; }
        .btn { cursor: pointer; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; color: white; transition: 0.3s; display: inline-block; text-align: center; text-decoration: none; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-warn { background: var(--warn); color: #000; }
        .btn-sm { padding: 8px 12px; font-size: 13px; margin: 2px; }
        .full-w { width: 100%; }

        .table-container { overflow-x: auto; border-radius: 8px; }
        .table-res { width: 100%; border-collapse: collapse; min-width: 600px; }
        .table-res th, .table-res td { padding: 12px; border: 1px solid #334155; text-align: left; }
        .table-res th { background: #111827; position: sticky; top: 0; }
        
        .history-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .q-box { background: white; color: #1e293b; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 6px solid var(--primary); }

        #timer-banner { background: var(--danger); text-align: center; padding: 12px; font-weight: bold; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid rgba(0,0,0,0.2); }
        .badge-count { background: white; color: var(--danger); padding: 2px 8px; border-radius: 20px; margin-left: 10px; font-size: 0.8rem; }

        /* Modal Styling */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .modal-content { background: var(--slate); margin: 5% auto; padding: 25px; border-radius: 15px; width: 90%; max-width: 700px; border: 1px solid var(--primary); }

        @media (max-width: 600px) {
            .btn { width: 100%; margin-bottom: 5px; }
            .history-grid { grid-template-columns: 1fr; }
        }

  

.view-section {
    display: none; /* Default hidden */
}
.view-section.active {
    display: block; /* Shown when active */
}
@media (max-width: 900px) {
    .monitor-grid {
        grid-template-columns: 1fr !important;
    }
}



@media (max-width: 992px) {
    .monitor-grid {
        display: block !important; /* Disables the side-by-side grid */
    }

    .monitor-grid > .card {
        width: 100% !important;
        margin-bottom: 20px !important;
    }

    /* Make the sidebar feed full width */
    #realtime-feed {
        height: 350px !important;
    }
}

/* 2. Table Protection */
/* Prevents the table from squashing and breaking the layout */
.table-container {
    width: 100% !important;
    overflow-x: auto !important;
    display: block !important;
    -webkit-overflow-scrolling: touch;
}

.table-res {
    min-width: 600px !important; /* Ensures columns stay readable */
}

/* 3. Join & Result Screen Fixes */
@media (max-width: 600px) {
    #view-join .card, #view-result .card, #view-public-results .card {
        width: 95% !important;
        margin: 10px auto !important;
        padding: 15px !important;
    }

    /* Stack the public search inputs */
    #view-public-results div[style*="grid-template-columns"] {
        display: flex !important;
        flex-direction: column !important;
    }
    
    #timer-banner {
        font-size: 14px !important;
        padding: 10px !important;
        text-align: center;
    }
}

/* 4. General Cleanup */
input, button {
    max-width: 100% !important;
    box-sizing: border-box !important;
}

.card {
    box-sizing: border-box !important;
}

/* Fixes the side-by-side buttons in the monitor */
div[style*="display:flex"] {
    flex-wrap: wrap !important;
    gap: 10px !important;
}




/* Force the rank numbers to be visible white/light color on dark background */
#public-board-body td:first-child {
    color: #ffffff !important; 
    opacity: 1 !important;
    visibility: visible !important;
    text-align: center;
}
    </style>
</head>
<body>

    <div id="gradeModal" class="modal">
        <div class="modal-content">
            <h2 id="modal-st-name">Grade Submission</h2>
            <div id="modal-body" style="max-height: 60vh; overflow-y: auto; margin-bottom: 20px;"></div>
            <div style="display: flex; gap: 10px;">
                <input type="number" id="manual-marks" placeholder="Enter Total Marks for Descriptive Part" style="flex: 1;">
                <button onclick="submitManualGrade()" class="btn btn-success">Update Final Score</button>
                <button onclick="closeModal()" class="btn btn-danger">Cancel</button>
            </div>
        </div>
    </div>

    <div style="background: #000; padding: 10px 20px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155;">
        <span id="db-status"><i class="fas fa-circle"></i> Connecting...</span>
        <span id="user-display">EduFlow Hybrid Mode</span>
    </div>

    <div id="app">
          <section id="view-start" class="view-section active">  
          
            <div style="text-align: center; margin-top: 10vh;">
                <h1><i class="fas fa-graduation-cap"></i> EDUFLOW PRO</h1>
                <p style="color:#94a3b8">Hybrid MCQ & Long-Answer Assessment System</p>
                <div style="margin-top: 30px; display: grid; gap: 15px; max-width: 400px; margin-left: auto; margin-right: auto;">
                    <button onclick="switchView('view-teacher-login')" class="btn btn-primary">TEACHER PORTAL</button>
                    <button onclick="switchView('view-join')" class="btn btn-success">STUDENT JOIN</button>
                    <button onclick="switchView('view-public-results')" class="btn btn-warn">VIEW RESULTS (QR)</button>
                    <a href="index.html" style="text-decoration: none; color: white; background: green; padding: 10px; display: inline-block;">
  Go To Home
</a>

                </div>
            </div>
        </section>

        <section id="view-teacher-login" class="view-section">
            <div class="card" style="max-width: 400px; margin: auto;">
                <h3><i class="fas fa-lock"></i> Teacher Authentication</h3>
                <input type="text" id="t-user" placeholder="Teacher Username">
                <input type="password" id="t-pass" placeholder="Password">
                <button onclick="authTeacher()" class="btn btn-primary full-w">Login / Sign Up</button>
                <button onclick="switchView('view-start')" class="btn btn-sm full-w" style="margin-top:10px; background:none">Cancel</button>
            </div>
        </section>

        <section id="view-setup" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 10px;">
                <h2>Teacher Dashboard</h2>
                <button onclick="location.reload()" class="btn btn-sm btn-danger">Logout</button>
            </div>

            <div class="card">
                <h3><i class="fas fa-plus"></i> Configure New Test</h3>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:10px;">
                    <input type="text" id="ex-id" placeholder="Exam Code (e.g., TEST-01)">
                    <input type="number" id="ex-duration" placeholder="Total Time (Mins)">
                    <input type="number" id="ex-pass" placeholder="Passing Score %">
                    <!-- <input type="date" id="ex-expiry" title="Expiry Date"> -->
              <div style="display: flex; gap: 5px;">
    <input type="date" id="ex-expiry-date" title="Expiry Date" style="flex: 2;">
    <input type="time" id="ex-expiry-time" title="Expiry Time" style="flex: 1;">
</div>

                </div>



                
                <!-- <div style="margin: 15px 0; display: flex; gap: 20px; flex-wrap: wrap; background: #111827; padding: 15px; border-radius: 8px; border: 1px solid #334155;">
                    <label><input type="checkbox" id="ex-neg"> Enable Negative Marking (-1)</label>
                    <label><input type="checkbox" id="ex-hold" checked> Hold Results for Review</label>
                    <label style="color: var(--warn)"><input type="checkbox" id="ex-email"> üìß Enable Email Automation</label>

                </div> -->
     <div class="card" id="ai-creator-container" style="margin-top: 20px; border: 1px solid #3b82f6;">
    <h2 style="color: var(--primary)">‚ú® AI Magic Test Creator</h2>
    <p style="font-size: 12px; color: #888; margin-bottom: 15px;">Fill details to auto-generate questions using AI.</p>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <input type="text" id="ai-subject" placeholder="Subject (e.g., Science)">
        <select id="ai-difficulty" style="background: #1f2937; color: white; border: 1px solid #374151; padding: 8px; border-radius: 5px;">
            <option value="easy">Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
        </select>
        <input type="number" id="ai-mcq-count" placeholder="MCQ Quantity">
        <input type="number" id="ai-long-count" placeholder="Long Q Quantity">
        <input type="number" id="ai-pass-marks" placeholder="Pass % (e.g. 40)">
        <input type="datetime-local" id="ai-expiry">
    </div>
    <button id="ai-gen-btn" onclick="generateAiExam(event)" class="btn btn-primary" style="margin-top:20px; width:100%; font-weight: bold;">
        üöÄ Generate & Publish Test
    </button>
</div>

                <div id="setup-qs"></div>
                
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button onclick="addQField('mcq')" class="btn btn-sm btn-primary">+ MCQ</button>
                    <button onclick="addQField('long')" class="btn btn-sm btn-warn">+ Long Answer</button>
                </div>
                <button onclick="launchExam()" class="btn btn-success full-w" style="margin-top:20px; padding: 15px;">ACTIVATE TEST</button>
            </div>

            <div class="card">
                <h3><i class="fas fa-folder-open"></i> Manage Your Tests (History)</h3>
                <div id="history-list" class="history-grid"></div>
            </div>
        </section>

<section id="view-monitor" class="view-section" style="display: none;">
    <div id="timer-banner">
        MONITORING: <span id="mon-id"></span>
        <span class="badge-count">Live Students: <span id="live-count">0</span></span>
    </div>

    <div class="card" style="margin-top: 10px; padding: 10px;">
        <div style="position: relative;">
            <i class="fas fa-search" style="position: absolute; left: 10px; top: 12px; color: #888;"></i>
            <input type="text" id="student-search" placeholder="Search student name..." 
                   onkeyup="filterMonitorTable()" 
                   style="width: 100%; padding: 8px 8px 8px 35px; border-radius: 20px; border: 1px solid #ddd; outline: none;">
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 350px; gap: 15px; margin-top: 10px; align-items: start;" class="monitor-grid">
        
        <div class="card" style="margin-top: 0;">
            <div style="display:flex; gap:5px; margin-bottom:15px; flex-wrap: wrap; justify-content: space-between;">
                <div>
                    <button class="btn btn-sm btn-primary" onclick="toggleFilter('all')">All</button>
                    <button class="btn btn-sm btn-success" onclick="toggleFilter('pass')">Passed</button>
                    <button class="btn btn-sm btn-danger" onclick="toggleFilter('fail')">Failed</button>
                    <button class="btn btn-sm btn-warn" onclick="toggleFilter('grading')">Need Review</button>
                </div>
                <div>
                    <button class="btn btn-sm btn-warn" onclick="bulkEmailResults()"><i class="fas fa-envelope"></i> Email All</button>
                    <button class="btn btn-sm btn-success" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Export Excel</button>
                                        <div style="margin-top: 15px; background: #1e293b; padding: 15px; border-radius: 8px; border: 1px solid #334155;">
    <button onclick="bulkAiGrade()" id="btn-bulk-ai" class="btn btn-sm" style="background: #8b5cf6; color: white;">
        ü§ñ Bulk AI Grade (All Students)
    </button>
    
    <div id="ai-progress-container" style="display:none; margin-top: 10px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <span id="bulk-ai-status" style="font-size: 12px; color: #e2e8f0;">Ready...</span>
            <span id="ai-perc" style="font-size: 12px; font-weight: bold; color: #a78bfa;">0%</span>
        </div>
        <div style="width: 100%; background: #334155; height: 8px; border-radius: 4px; overflow: hidden;">
            <div id="ai-bar" style="width: 0%; height: 100%; background: #8b5cf6; transition: width 0.3s;"></div>
        </div>
    </div>
</div>
                </div>
            </div>
            
            <div class="table-container">
                <table class="table-res">
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Score</th>
                            <th>Result</th>
                            <th>Integrity</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="monitor-body"></tbody>
                </table>
            </div>
        </div>

        <div class="card" style="margin-top: 0; position: sticky; top: 10px;">
            <h4 style="margin-bottom: 10px;"><i class="fas fa-bolt" style="color: #ffc107;"></i> Real-Time Feed</h4>
            <div id="realtime-feed" style="height: 400px; overflow-y: auto; background: rgba(0,0,0,0.05); padding: 10px; border-radius: 8px; font-size: 13px;">
                <p style="color: #888; text-align: center; margin-top: 20px;">Waiting for activity...</p>
            </div>
            <p style="font-size: 10px; color: #666; margin-top: 5px;">*Shows first selected option only</p>
        </div>
    </div>

    <div class="card" style="text-align: center; margin-top: 15px;">
        <h4>Exam Result QR Code</h4>
        <div id="qrcode-mon" style="background:white; padding:15px; display:inline-block; border-radius:10px;"></div>
        
        <div style="margin-top: 10px;">
            <button onclick="downloadQR()" class="btn btn-sm" style="background: var(--primary); color: white; cursor: pointer;">
                <i class="fas fa-download"></i> Download QR
            </button>
            <button onclick="printQRCode()" class="btn btn-sm" style="background: #6c757d; color: white; cursor: pointer;">
                <i class="fas fa-print"></i> Print
            </button>
        </div>

        <p><small>Students can scan this to check the result list for this specific test.</small></p>
    </div>

    <button onclick="switchView('view-setup')" class="btn btn-primary" style="width: 100%; margin-top: 15px;">Return to Dashboard</button>

</section>



        

        <section id="view-join" class="view-section">
            <div class="card" style="max-width: 400px; margin: auto;">
                <h3>Join Examination</h3>
                <input type="text" id="st-teacher-id" placeholder="Teacher Username">
                <input type="text" id="st-code" placeholder="Test Code">
                <hr style="border-color: #334155">
                <input type="text" id="st-name" placeholder="Your Full Name">
                <input type="email" id="st-email" placeholder="Email Address">
                <button onclick="studentJoin()" class="btn btn-primary full-w">Start Examination</button>
            </div>
        </section>

         <section id="view-paper" class="view-section">
            <div id="timer-banner">TIME REMAINING: <span id="timer-clock">00:00</span></div>
            <div id="paper-content" style="margin-top:20px;"></div>
            <button onclick="finishTest()" class="btn btn-success full-w" style="padding: 20px; font-size: 1.2rem; margin-top: 20px;">SUBMIT TEST</button>
        </section> 

        <section id="view-result" class="view-section">
    <div id="student-score-box" class="card" style="background: white; color: #1e293b; max-width: 500px; margin: 5vh auto; padding: 20px; border-radius: 15px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);">
        </div>
    <div id="student-status-box" style="text-align:center; margin-top:20px; font-weight:bold; font-size:1.2rem;"></div>
    
    <div style="text-align: center; display: flex; flex-direction: column; align-items: center; gap: 10px;">
        <button onclick="genSubmissionPDF()" class="btn btn-primary" style="width: 250px;">
            <i class="fas fa-file-pdf"></i> Download Receipt (PDF)
        </button>
        <button onclick="location.href=window.location.pathname" class="btn" style="margin-top:20px; background: var(--slate); color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; width: 250px;">
            <i class="fas fa-home"></i> Return to Home
        </button>
    </div>
</section>

        <section id="view-public-results" class="view-section">





   <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
    <input type="text" id="student-search" oninput="filterResults()" placeholder="Search name..." 
           style="flex-grow: 1; padding: 10px; background: #111827; color: white; border: 1px solid #334155; border-radius: 8px;">


            <div class="card">
                <h2>Public Result Portal</h2>
                <div style="display:grid; grid-template-columns: 1fr 1fr auto; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="res-t-id" placeholder="Teacher ID">
                    <input type="text" id="res-e-id" placeholder="Test Code">
                    <button onclick="loadPublicBoard()" class="btn btn-primary">Search</button>
                </div>
                <div class="table-container">
                    <table class="table-res">
                        <!-- <thead><tr><th>Rank</th><th>Name</th><th>Total</th><th>Status</th></tr></thead> -->
                        <thead><tr><th>Rank</th><th>Name</th><th>Total</th><th>Status</th><th>Action</th></tr></thead>
                        <tbody id="public-board-body"></tbody>
                    </table>
                </div>
            </div>
            <button onclick="switchView('view-start')" class="btn btn-sm btn-primary">Back Home</button>
        </section>
    </div>

<script>
// --- CORE CONFIG ---
const firebaseConfig = {
    apiKey: "AIzaSyAQtBdy0vsMJo6vEga452Elu5P3iTwUnhs",
    authDomain: "eduflow-pro-assess.firebaseapp.com",
    databaseURL: "https://eduflow-pro-assess-default-rtdb.firebaseio.com",
    projectId: "eduflow-pro-assess",
    storageBucket: "eduflow-pro-assess.firebasestorage.app",
    messagingSenderId: "62529929501",
    appId: "1:62529929501:web:21053e00008982a9ca61f4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentTeacher = "";
let currentExam = null;
let gradingStudent = null;
let stState = { name: "", email: "", id: "", teacher: "", answers: {}, pastes: 0 };
let currentFilter = 'all';

db.ref('.info/connected').on('value', s => {
    document.getElementById('db-status').innerHTML = s.val() ? '<i class="fas fa-circle" style="color:var(--success)"></i> Live' : '<i class="fas fa-circle" style="color:var(--danger)"></i> Offline';
});




function switchView(id) {
    const target = document.getElementById(id);
    
    // Safety check: if the requested ID doesn't exist, show the home screen
    if (!target) {
        console.error("View not found: " + id);
        const start = document.getElementById('view-start');
        if (start) {
            start.classList.add('active');
            start.style.display = 'block';
        }
        return;
    }

    // 1. Hide EVERY section and remove active class
    document.querySelectorAll('.view-section').forEach(v => {
        v.classList.remove('active');
        v.style.display = 'none'; // Force hide
    });

    // 2. Show ONLY the requested section
    target.classList.add('active');
    target.style.display = 'block'; // Force show

    // 3. Reset scroll position
    window.scrollTo(0,0);
    console.log("Navigated to:", id);
}


const PUBLIC_KEY = "aDv7N0Ry8Yq1VsNlw"; 
const SERVICE_ID = "service_ruuzmdf";
const TEMPLATE_ID = "template_xxcgwad";

(function() {
    emailjs.init(PUBLIC_KEY);
})();

function sendEmailResult(name, email, score, total, status) {
    if(!email) return;

    // UNIQUE FEATURE: Dynamic Encouragement Logic
    let encouragement = "";
    const percentage = (score / total) * 100;

    if (percentage >= 90) {
        encouragement = "Exceptional work! You've mastered this topic.";
    } else if (percentage >= 50) {
        encouragement = "Good effort! You're on the right track.";
    } else {
        encouragement = "Keep going! Mastery takes practice, and we're here to help.";
    }

    emailjs.send(SERVICE_ID, TEMPLATE_ID, {
        to_email: email,
        name: name,
        score: `${score}/${total}`,
        status: status,
        personal_note: encouragement, // Add {{personal_note}} to your EmailJS template!
        exam_id: currentExam.config.id
    });
}


// --- TEACHER LOGIC ---
async function authTeacher() {
    const user = document.getElementById('t-user').value.trim().toLowerCase();
    const pass = document.getElementById('t-pass').value;
    if(!user || !pass) return alert("Please fill all fields");
    const snap = await db.ref(`teachers/${user}/auth`).once('value');
    if(snap.exists() && snap.val().pass !== pass) return alert("Incorrect Password");
    if(!snap.exists()) await db.ref(`teachers/${user}/auth`).set({pass});
    currentTeacher = user;
    document.getElementById('user-display').innerText = `Teacher: ${user}`;
    switchView('view-setup');
    initHistoryListener();
}

function addQField(type) {
    const container = document.getElementById('setup-qs');
    const div = document.createElement('div');
    div.className = "card";
    div.style.background = "#1e293b";
    div.dataset.type = type;
    div.innerHTML = `
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <b>${type === 'mcq' ? 'Multiple Choice' : 'Long Answer'}</b>
            <button onclick="this.parentElement.parentElement.remove()" class="btn btn-sm btn-danger">Remove</button>
        </div>
        <input type="text" class="q-txt" placeholder="Question Text">
        <input type="number" class="q-marks" placeholder="Marks" value="${type === 'mcq' ? 1 : 10}" style="width: 100px;">
        ${type === 'mcq' ? `
            <input type="text" class="o1" placeholder="Option A">
            <input type="text" class="o2" placeholder="Option B">
            <input type="text" class="q-cor" placeholder="Exact Correct Text (Case Sensitive)" style="border-color: var(--success)">
        ` : `<p><small>System will flag this for manual grading after student submission.</small></p>`}
    `;
    container.appendChild(div);
}

async function launchExam() {
    const id = document.getElementById('ex-id').value.trim();
    
    // --- NECESSARY CHANGE START: Collect separate Date and Time ---
    const dateInput = document.getElementById('ex-expiry-date').value;
    const timeInput = document.getElementById('ex-expiry-time').value;
    
    if(!id || !dateInput || !timeInput) return alert("Exam ID, Expiry Date, and Time are required");

    // Combine Date and Time into one Date object
    const combinedExpiryString = `${dateInput}T${timeInput}`; 
    const expiryTimestamp = new Date(combinedExpiryString).getTime();
    // --- NECESSARY CHANGE END ---

    const qs = [];
    document.querySelectorAll('#setup-qs .card').forEach(c => {
        const type = c.dataset.type;
        qs.push({
            type,
            text: c.querySelector('.q-txt').value,
            marks: parseInt(c.querySelector('.q-marks').value),
            options: type === 'mcq' ? [c.querySelector('.o1').value, c.querySelector('.o2').value] : null,
            correct: type === 'mcq' ? c.querySelector('.q-cor').value : null
        });
    });

    const now = new Date();
    const timeString = now.toLocaleTimeString();

    const config = {
        id,
        dur: document.getElementById('ex-duration').value || 30,
        passLimit: document.getElementById('ex-pass').value || 40,
        expiry: expiryTimestamp, // Using the new combined timestamp
        negative: document.getElementById('ex-neg').checked,
        hold: document.getElementById('ex-hold').checked,
        emailEnabled: document.getElementById('ex-email').checked,
        createdAt: Date.now(),
        launchTime: timeString 
    };

    try {
        await db.ref(`teachers/${currentTeacher}/exams/${id}`).set({config, questions: qs});
        
        if (typeof generateMonitorQR === "function") {
            generateMonitorQR(currentTeacher, id);
        }

        alert(`Test Launched Successfully at ${timeString}!`);
        
        document.getElementById('mon-id').innerText = id;
        switchView('view-monitor');
        
        document.getElementById('setup-qs').innerHTML = "";
        document.getElementById('ex-id').value = "";
        // Clear the new date/time fields too
        document.getElementById('ex-expiry-date').value = "";
        document.getElementById('ex-expiry-time').value = "";
    } catch (error) {
        console.error("Launch failed:", error);
        alert("Error launching test. Check console.");
    }
}




// function initHistoryListener() {
//     db.ref(`teachers/${currentTeacher}/exams`).on('value', snap => {
//         const container = document.getElementById('history-list');
//         container.innerHTML = "";
//         const tests = snap.val();
//         if(!tests) return container.innerHTML = "<p>No tests created yet.</p>";
//         Object.keys(tests).forEach(id => {
//             const t = tests[id];
//             const expired = Date.now() > t.config.expiry;
//             container.innerHTML += `
//                 <div class="card" style="border-top: 4px solid ${expired ? 'var(--danger)' : 'var(--success)'}">
//                     <h4 style="margin:0">${id}</h4>
//                     <p style="font-size:12px; color:#94a3b8">Expiry: ${new Date(t.config.expiry).toLocaleDateString()}</p>
//                     <div style="display:flex; gap:5px; margin-top:10px;">
//                         <button onclick="openMonitor('${id}')" class="btn btn-sm btn-primary">Monitor</button>
//                         <button onclick="deleteExam('${id}')" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>
  
//                     </div>
//                 </div>
//             `;
//         });
//     });
// }


function initHistoryListener() {
    db.ref(`teachers/${currentTeacher}/exams`).on('value', snap => {
        const container = document.getElementById('history-list');
        container.innerHTML = "";
        const tests = snap.val();
        
        if(!tests) return container.innerHTML = "<p style='color:#64748b; text-align:center;'>No tests created yet.</p>";

        Object.keys(tests).forEach(id => {
            const t = tests[id];
            // Check if test is expired (Safety check for missing expiry)
            const expiryDate = t.config && t.config.expiry ? t.config.expiry : Date.now();
            const expired = Date.now() > expiryDate;
            
            // Identify AI tests by their ID prefix
            const isAI = id.startsWith('AI-');
            const typeBadge = isAI 
                ? `<span style="background:#6366f1; color:white; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:10px;">‚ú® AI GEN</span>` 
                : `<span style="background:#10b981; color:white; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:10px;">üìù MANUAL</span>`;

            container.innerHTML += `
                <div class="card" style="border-top: 4px solid ${expired ? 'var(--danger)' : 'var(--success)'}; position:relative;">
                    <div style="display:flex; align-items:center; justify-content:space-between;">
                        <h4 style="margin:0">${id}</h4>
                        ${typeBadge}
                    </div>
                    <p style="font-size:12px; color:#94a3b8; margin: 8px 0;">
                        Expiry: ${new Date(expiryDate).toLocaleDateString()} ${new Date(expiryDate).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                    </p>
                    <div style="display:flex; gap:5px; margin-top:10px;">
                        <button onclick="openMonitor('${id}')" class="btn btn-sm btn-primary" style="flex:1;">Monitor</button>
                        <button onclick="deleteExam('${id}')" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        });
    });
}

function openMonitor(id) {
    db.ref(`teachers/${currentTeacher}/exams/${id}`).once('value', snap => {
        currentExam = snap.val();
        document.getElementById('mon-id').innerText = id;
        
        // 1. Build the table structure with the new Voice ID header
        const monitorCard = document.getElementById('monitor-card');
        if (monitorCard) {
            monitorCard.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Voice ID</th>
                            <th>Score</th>
                            <th>Status</th>
                            <th>Integrity</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="monitor-body"></tbody>
                </table>
            `;
        }

        switchView('view-monitor');
        startMonitorSync(id);
    });
}




let monitorInterval;

function startMonitorSync(id) {
    // RECOVERY: If currentTeacher is lost, try to get it from a global state or prompt
    if (!currentTeacher) {
        console.error("Monitor error: Teacher ID is missing!");
        // Optional: currentTeacher = localStorage.getItem('lastTeacher');
        return;
    }


    const qrBox = document.getElementById('qrcode-mon');
    qrBox.innerHTML = "";

    // Correct URL generation
    const cleanURL = window.location.origin + window.location.pathname + `?res=${encodeURIComponent(currentTeacher)}:${encodeURIComponent(id)}`;
    
    new QRCode(qrBox, { 
        text: cleanURL, 
        width: 150, 
        height: 150,
        correctLevel: QRCode.CorrectLevel.H 
    });
    listenToFeed(id);

    // REAL-TIME LISTENER
    // We use .on('value') which is perfect for real-time typing/updates
    db.ref(`live/${currentTeacher}/${id}`).on('value', snap => {
        const body = document.getElementById('monitor-body');
        const students = snap.val();
        
        // Update the live counter header
        const count = students ? Object.keys(students).length : 0;
        const countEl = document.getElementById('live-count');
        if(countEl) countEl.innerText = count;

        if(!students) {
            body.innerHTML = "<tr><td colspan='6' style='text-align:center; padding: 20px;'>Waiting for students...</td></tr>";
            return;
        }

        let html = "";
        Object.keys(students).forEach(name => {
            const s = students[name];
            
            // Filter Logic
            if(currentFilter === 'pass' && s.status !== 'Pass') return;
            if(currentFilter === 'fail' && s.status !== 'Fail') return;
            if(currentFilter === 'grading' && !s.needsGrading) return;

            // REAL-TIME VISUAL: Change row color if they are currently typing/active
            const isTyping = (Date.now() - (s.lastActive || 0)) < 1000; 

            html += `
                <tr style="background: ${isTyping ? 'rgba(34, 197, 94, 0.1)' : (s.needsGrading ? 'rgba(245, 158, 11, 0.1)' : 'transparent')}">
                    <td>
                        <b>${name}</b> ${isTyping ? '<small style="color:var(--success)">‚úçÔ∏è typing...</small>' : ''}
                        <br><small>${s.email || ''}</small>
                    </td>
                    <td>
                        ${s.voiceAuth ? `<button onclick="playVoice('${s.voiceAuth}')" class="btn-sm" style="background:var(--primary)">Listen</button>` : '<span style="color:#667">No Voice</span>'}
                    </td>
                    <td>${s.score !== undefined && s.score !== null ? s.score : '??'} / ${s.totalPossible || 0}</td>
                    <td><span class="btn-sm" style="background:${s.status === 'Pass' ? 'var(--success)' : (s.status === 'Fail' ? 'var(--danger)' : 'var(--warn)')}">${s.status || 'Testing'}</span></td>
                    <td>${s.pastes > 0 ? `<span style="color:var(--danger)">‚ö†Ô∏è ${s.pastes}</span>` : 'Clean'}</td>
                    <td>
                        ${s.needsGrading ? `<button onclick="openGradingModal('${name}')" class="btn btn-sm btn-warn">Grade</button>` : '<i class="fas fa-check-circle" style="color:var(--success)"></i>'}
                    </td>
                </tr>
            `;
        });
        body.innerHTML = html;
    });
}


// Helper function to create a pause
const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

async function bulkEmailResults() {
    if(!confirm("Send emails to all completed students?")) return;
    
    const snap = await db.ref(`live/${currentTeacher}/${currentExam.config.id}`).once('value');
    const students = snap.val();
    if(!students) return;

    const uids = Object.keys(students);
    let count = 0;

    for (const uid of uids) {
        const s = students[uid];
        
        if(!s.needsGrading && s.done && s.email) {
            sendEmailResult(s.name, s.email, s.score, s.totalPossible, s.status);
            count++;

      
            await sleep(1000); 
            
            console.log(`Sent ${count} of ${uids.length}`);
        }
    }
    
    alert(`Successfully processed ${count} emails.`);
}

async function exportToExcel() {
    const snap = await db.ref(`live/${currentTeacher}/${currentExam.config.id}`).once('value');
    const students = snap.val();
    if(!students) return alert("No data to export");

    const rows = Object.keys(students).map(name => ({
        Name: name,
        Email: students[name].email,
        Score: students[name].score,
        Total: students[name].totalPossible,
        Status: students[name].status,
        Pastes: students[name].pastes
    }));

    const worksheet = XLSX.utils.json_to_sheet(rows);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Results");
    XLSX.writeFile(workbook, `${currentExam.config.id}_Results.xlsx`);
}

// --- PROFESSIONAL GRADING MODAL ---
function openGradingModal(stName) {
    gradingStudent = stName;
    db.ref(`live/${currentTeacher}/${currentExam.config.id}/${stName}`).once('value', snap => {
        const s = snap.val();
        document.getElementById('modal-st-name').innerText = `Reviewing: ${stName}`;
        let html = "";
        currentExam.questions.forEach((q, i) => {
            if(q.type === 'long') {
                html += `
                    <div style="background:#0f172a; padding:15px; border-radius:8px; margin-bottom:15px; border-left:4px solid var(--warn)">
                        <p><b>Question:</b> ${q.text}</p>
                        <p style="color:#94a3b8"><b>Student Answer:</b></p>
                        <div style="background:#1e293b; padding:10px; border-radius:5px; white-space:pre-wrap;">${s.ans[i] || 'No Answer'}</div>
                    </div>
                `;
            }
        });
        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('gradeModal').style.display = 'block';
    });
}

function closeModal() {
    document.getElementById('gradeModal').style.display = 'none';
}

async function submitManualGrade() {
    const marks = document.getElementById('manual-marks').value;
    if(marks === "") return alert("Please enter marks");
    
    const snap = await db.ref(`live/${currentTeacher}/${currentExam.config.id}/${gradingStudent}`).once('value');
    const s = snap.val();
    
    const finalScore = (s.mcqScore || 0) + parseInt(marks);
    const status = (finalScore / s.totalPossible * 100) >= currentExam.config.passLimit ? "Pass" : "Fail";
    
    await db.ref(`live/${currentTeacher}/${currentExam.config.id}/${gradingStudent}`).update({
        score: finalScore, status, needsGrading: false
    });

    if(currentExam.config.emailEnabled) {
        sendEmailResult(gradingStudent, s.email, finalScore, s.totalPossible, status);
    }

    closeModal();
    alert("Grading Updated!");
}


function studentJoin() {
    const tId = document.getElementById('st-teacher-id').value.trim().toLowerCase();
    const eId = document.getElementById('st-code').value.trim();
    const name = document.getElementById('st-name').value.trim();
    const email = document.getElementById('st-email').value.trim();
    if(!tId || !eId || !name) return alert("All fields are mandatory");

    db.ref(`teachers/${tId}/exams/${eId}`).once('value', snap => {
        const test = snap.val();
        if(!test) return alert("Examination not found!");
        if(Date.now() > test.config.expiry) return alert("This test link has expired!");
        currentExam = test;
        stState = { name, email, id: eId, teacher: tId, answers: {}, pastes: 0 };
        
        // Pre-create student record for Live Counter
        db.ref(`live/${tId}/${eId}/${name}`).update({joined: true, email: email, status: 'In Progress'});
        
        renderExamPaper();
        switchView('view-paper');
        startMainClock(test.config.dur);
    });
}

function renderExamPaper() {
    const cont = document.getElementById('paper-content');
    cont.innerHTML = currentExam.questions.map((q, i) => `
        <div class="q-box">
            <p><b>Question ${i+1}: ${q.text}</b> <span style="float:right">(${q.marks}M)</span></p>
            ${q.type === 'mcq' ? 
                q.options.map((opt, idx) => `
                    <label style="display:block; margin: 10px 0; cursor:pointer;">
                        <input type="radio" name="q${i}" onclick="saveProgress(${i}, '${opt}')"> ${opt}
                    </label>
                `).join('') 
                : `<textarea oninput="saveProgress(${i}, this.value)" onpaste="stState.pastes++" placeholder="Type your answer here..."></textarea>`
            }
        </div>
    `).join('');
}



function saveProgress(qIdx, val) {
    // 1. Update local state
    stState.answers[qIdx] = val;
    stState.lastActive = Date.now();

    // 2. Push to Firebase (Official State)
    db.ref(`live/${stState.teacher}/${stState.id}/${stState.name}`).update({
        ans: stState.answers, 
        pastes: stState.pastes, 
        lastActive: stState.lastActive,
        status: 'In Progress',
        done: false
    }).catch(err => console.error("Sync Error:", err));

    // --- Real-Time Feed Logic (Ensuring Question & Answer are visible) ---
    const logRef = db.ref(`logs/${stState.teacher}/${stState.id}/${stState.name}/q${qIdx}`);
    
    logRef.once('value').then(snap => {
        if (!snap.exists()) {
            // We use qNum and answer keys. 
            // We also ensure 'val' is converted to a string in case it's a number/null.
            logRef.set({
                qNum: qIdx + 1,
                answer: val ? val.toString() : "No selection", 
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            });
        }
    });
}



function startMainClock(mins) {
    let timeLeft = mins * 60;
    const interval = setInterval(() => {
        const m = Math.floor(timeLeft / 60);
        const s = timeLeft % 60;
        document.getElementById('timer-clock').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        if(timeLeft <= 0) { clearInterval(interval); finishTest(); }
        timeLeft--;
    }, 1000);
}

async function finishTest() {
    let mcqScore = 0;
    let totalPossible = 0;
    let hasLong = false;

    currentExam.questions.forEach((q, i) => {
        totalPossible += q.marks;
        if(q.type === 'mcq') {
            const isCorrect = (stState.answers[i] === q.correct);
            if(isCorrect) mcqScore += q.marks;
            else if(currentExam.config.negative && stState.answers[i]) mcqScore -= 1;
        } else hasLong = true;
    });

    const perc = (mcqScore / totalPossible) * 100;
    const status = perc >= currentExam.config.passLimit ? "Pass" : "Fail";

    const finalData = {
        email: stState.email,
        mcqScore,
        totalPossible,
        needsGrading: hasLong,
        timestamp: Date.now(),
        ans: stState.answers,
        pastes: stState.pastes,
        done: true,
        status: hasLong ? "Reviewing" : status,
        score: hasLong ? null : mcqScore
    };

    const scoreBox = document.getElementById('student-score-box');
    const statusBox = document.getElementById('student-status-box');

    if(!hasLong) {
        if(!currentExam.config.hold) {
            scoreBox.innerHTML = `<h3>Your Score: ${mcqScore} / ${totalPossible}</h3>`;
            statusBox.innerHTML = `Status: <span style="color:${status === 'Pass' ? 'var(--success)' : 'var(--danger)'}">${status}</span>`;
        } else {
            scoreBox.innerHTML = `<h3>Submitted Successfully</h3>`;
            statusBox.innerHTML = `<p>Results are being held by the teacher.</p>`;
        }
        
        if(currentExam.config.emailEnabled) {
            sendEmailResult(stState.name, stState.email, mcqScore, totalPossible, status);
        }
    } else {
        scoreBox.innerHTML = `<h3>Descriptive Test Submitted</h3>`;
        statusBox.innerHTML = `<p>Manual grading required. Teacher will review your answers.</p>`;
    }

    await db.ref(`live/${stState.teacher}/${stState.id}/${stState.name}`).set(finalData);
    switchView('view-result');
}


async function deleteExam(id) {
    if(confirm(`Delete all data for test ${id}?`)) {
        await db.ref(`teachers/${currentTeacher}/exams/${id}`).remove();
        await db.ref(`live/${currentTeacher}/${id}`).remove();
    }
}

// function loadPublicBoard() {
//     const tId = document.getElementById('res-t-id').value.trim().toLowerCase();
//     const eId = document.getElementById('res-e-id').value.trim();
//     db.ref(`live/${tId}/${eId}`).once('value', snap => {
//         const container = document.getElementById('public-board-body');
//         container.innerHTML = "";
//         const data = snap.val();
//         if(!data) return alert("No results found.");
//         const sorted = Object.keys(data).sort((a,b) => (data[b].score || 0) - (data[a].score || 0));
//         sorted.forEach((name, i) => {
//             const s = data[name];
//             container.innerHTML += `
//                 <tr>
//                     <td>${i+1}</td>
//                     <td>${name}</td>
//                     <td>${s.score !== null && s.score !== undefined ? s.score + '/' + s.totalPossible : 'Grading...'}</td>
//                     <td><span class="btn-sm" style="background:${s.status === 'Pass' ? 'var(--success)' : (s.status === 'Fail' ? 'var(--danger)' : 'var(--warn)')}">${s.status || 'Pending'}</span></td>
//                 </tr>
//             `;
//         });
//     });
// }





// 1. Create a memory bank to hold the feedback safely
let feedbackMemory = {};

// function loadPublicBoard() {
//     const tId = document.getElementById('res-t-id').value.trim().toLowerCase();
//     const eId = document.getElementById('res-e-id').value.trim();
    
//     db.ref(`live/${tId}/${eId}`).once('value', snap => {
//         const container = document.getElementById('public-board-body');
//         container.innerHTML = "";
//         const data = snap.val();
        
//         if(!data) return alert("No results found.");
        
//         // Clear memory for the new search
//         feedbackMemory = {};

//         const sorted = Object.keys(data).sort((a,b) => (data[b].score || 0) - (data[a].score || 0));
        
//         sorted.forEach((name, i) => {
//             const s = data[name];

//             // 2. Store the long text in our memory bank using the name as a key
//             if (s.aiGraded) {
//                 feedbackMemory[name] = {
//                     feedback: s.aiFeedback || "No feedback.",
//                     plan: s.aiStudyPlan || "No plan."
//                 };
//             }

//             // 3. The button now only passes the NAME (no long strings)
//             let reviewBtn = s.aiGraded 
//                 ? `<button onclick="handleReviewClick('${name}')" style="background:#673ab7; color:white; border:none; padding:4px 10px; border-radius:4px; cursor:pointer; font-size:11px;">Review AI</button>`
//                 : `<span style="color:#ccc; font-size:11px;">N/A</span>`;

//             container.innerHTML += `
//                 <tr>
//                     <td>${i+1}</td>
//                     <td>${name}</td>
//                     <td>${s.score !== null && s.score !== undefined ? s.score + '/' + (s.totalPossible || 100) : 'Grading...'}</td>
//                     <td>
//                         <span class="btn-sm" style="background:${s.status === 'Pass' ? 'var(--success)' : (s.status === 'Fail' ? 'var(--danger)' : 'var(--warn)')}">
//                             ${s.status || 'Pending'}
//                         </span>
//                     </td>
//                     <td>${reviewBtn}</td>
//                 </tr>
//             `;
//         });
//     });
// }




function loadPublicBoard() {
    const tId = document.getElementById('res-t-id').value.trim().toLowerCase();
    const eId = document.getElementById('res-e-id').value.trim();
    
    if (!tId || !eId) return alert("Please enter both Teacher ID and Test Code.");

    // Switch to .on for REAL-TIME updates (Live Leaderboard)
    db.ref(`live/${tId}/${eId}`).on('value', snap => {
        const container = document.getElementById('public-board-body');
        container.innerHTML = "";
        const data = snap.val();
        
        if (!data) {
            container.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">No results found yet. Checking for live data...</td></tr>`;
            return;
        }
        
        // Reset memory for fresh AI data
        feedbackMemory = {};

        // Sort by score (Rank 1 at top)
        // const sorted = Object.keys(data).sort((a,b) => (data[b].score || 0) - (data[a].score || 0));
        // Replace the sort line in loadPublicBoard with this:
const sorted = Object.keys(data).sort((a, b) => {
    const scoreA = data[a].score || 0;
    const scoreB = data[b].score || 0;
    return scoreB - scoreA; // Highest score gets index 0 (Rank 1)
});

        sorted.forEach((name, i) => {
            const s = data[name];

            // 1. Store AI strings safely in memory bank
            if (s.aiGraded) {
                feedbackMemory[name] = {
                    feedback: s.aiFeedback || "Review complete.",
                    plan: s.aiStudyPlan || "No specific study plan generated."
                };
            }

        // Note the (name, i) -> 'i' is the index starting from 0


            // 2. Define the Review Button
            let reviewBtn = s.aiGraded 
                ? `<button onclick="handleReviewClick('${name}')" style="background:#6366f1; color:white; border:none; padding:5px 12px; border-radius:6px; cursor:pointer; font-weight:500; font-size:11px; transition:0.3s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">Review AI</button>`
                : `<span style="color:#94a3b8; font-size:11px; font-style:italic;">Processing...</span>`;

            // 3. Inject the Row
            // container.innerHTML += `
            //     <tr style="border-bottom: 1px solid #f1f5f9;">
            //         <td style="font-weight:bold; color: #1e293b;">${i+1}</td>
            //         <td style="color: #475569;">${name}</td>
            //         <td style="font-weight:600;">${s.score !== null ? s.score : 0} <span style="color:#94a3b8; font-weight:400;">/ ${s.totalPossible || 100}</span></td>
            //         <td>
            //             <span class="btn-sm" style="background:${s.status === 'Pass' ? 'var(--success)' : (s.status === 'Fail' ? 'var(--danger)' : '#f59e0b')}">
            //                 ${s.status || 'Pending'}
            //             </span>
            //         </td>
            //         <td>${reviewBtn}</td>
            //     </tr>
            // `;
            // 3. Inject the Row (Explicitly forcing color and content)

           
container.innerHTML += `
    <tr style="border-bottom: 1px solid #334155;">
        <td style="font-weight:bold; color: #ffffff; text-align: center; width: 50px;">
            ${(i + 1)}
        </td>
        <td style="color: #cbd5e1;">${name}</td>
        <td style="font-weight:600; color: #ffffff;">
            ${s.score !== null ? s.score : 0} 
            <span style="color:#94a3b8; font-weight:400;">/ ${s.totalPossible || 100}</span>
        </td>
        <td>
            <span class="btn-sm" style="background:${s.status === 'Pass' ? 'var(--success)' : (s.status === 'Fail' ? 'var(--danger)' : '#f59e0b')}">
                ${s.status || 'Pending'}
            </span>
        </td>
        <td>${reviewBtn}</td>
    </tr>
`;
        });
         filterResults();
    });
}

// 4. New helper function to bridge the button to the Modal
function handleReviewClick(studentName) {
    const data = feedbackMemory[studentName];
    if (data) {
        openReview(data.feedback, data.plan);
    }
}


function toggleFilter(f) {
    currentFilter = f;
    startMonitorSync(currentExam.config.id);
}

function genSubmissionPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(20);
    doc.text("EduFlow Submission Receipt", 10, 20);
    doc.setFontSize(12);
    doc.text(`Student: ${stState.name}`, 10, 40);
    doc.text(`Test: ${stState.id}`, 10, 50);
    doc.text(`Status: Submitted`, 10, 60);
    doc.text(`Date: ${new Date().toLocaleString()}`, 10, 70);
    doc.save(`${stState.name}_Receipt.pdf`);
}

async function downloadQR() {
    const container = document.getElementById("qrcode-mon");
    const qrCanvas = container.querySelector("canvas");
    const qrImg = container.querySelector("img");
    
    let source = qrCanvas || qrImg;
    if (!source) return alert("Generate QR first!");

    const virtualCanvas = document.createElement("canvas");
    const ctx = virtualCanvas.getContext("2d");
    
    virtualCanvas.width = 180; 
    virtualCanvas.height = 230; // Increased slightly for time/date text

    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, virtualCanvas.width, virtualCanvas.height);

    const drawAndDownload = () => {
        try {
            ctx.drawImage(source, 15, 10, 150, 150);

            ctx.fillStyle = "black";
            ctx.textAlign = "center";
            
            // 1. Get Exam ID from the UI or variable
            const examId = document.getElementById('mon-id').innerText || "Exam";
            
            // 2. Get Current Date/Time for the label
            const now = new Date();
            const dateStr = now.toLocaleDateString();
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            // Draw Text
            ctx.font = "bold 12px Arial";
            ctx.fillText(`ID: ${examId}`, virtualCanvas.width / 2, 185);
            
            ctx.font = "10px Arial";
            ctx.fillStyle = "#666";
            ctx.fillText(`${dateStr} | ${timeStr}`, virtualCanvas.width / 2, 202);
            
            ctx.fillStyle = "black";
            ctx.font = "italic 10px Arial";
            ctx.fillText("Scan to view results", virtualCanvas.width / 2, 220);

            const link = document.createElement("a");
            link.href = virtualCanvas.toDataURL("image/png");
            link.download = `QR_${examId}_${dateStr.replace(/\//g, '-')}.png`;
            link.click();
        } catch (err) {
            console.error("Canvas Export Failed:", err);
            alert("Security restriction: Try right-clicking the QR to save.");
        }
    };

    if (source.tagName === 'IMG' && !source.complete) {
        source.onload = drawAndDownload;
    } else {
        drawAndDownload();
    }
}

window.onload = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const resParam = urlParams.get('res');

    if (resParam) {
        // CASE A: QR Code Scanned
        const parts = resParam.split(':');
        if (parts.length === 2) {
            const [tId, eId] = parts;
            
            // Fill inputs
            document.getElementById('res-t-id').value = decodeURIComponent(tId);
            document.getElementById('res-e-id').value = decodeURIComponent(eId);

            // Show results view
            switchView('view-public-results');
            
            // Load the data
            setTimeout(() => {
                loadPublicBoard();
            }, 500);
        } else {
            // If the QR link is broken/wrong, show home
            switchView('view-start');
        }
    } else {
        // CASE B: Normal visit (No QR) - Show Home Screen
        switchView('view-start');
        
        // Restore student name if saved
        const savedName = localStorage.getItem('tempName');
        const nameInput = document.getElementById('st-name');
        if (savedName && nameInput) nameInput.value = savedName;
    }
};



// This ensures something ALWAYS shows up
document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const resParam = urlParams.get('res');

    if (resParam) {
        const parts = resParam.split(':');
        if (parts.length === 2) {
            const [tId, eId] = parts;
            
            // Fill inputs for public board
            if(document.getElementById('res-t-id')) document.getElementById('res-t-id').value = decodeURIComponent(tId);
            if(document.getElementById('res-e-id')) document.getElementById('res-e-id').value = decodeURIComponent(eId);

            switchView('view-public-results');
            
            setTimeout(() => {
                if (typeof loadPublicBoard === 'function') loadPublicBoard();
            }, 500);
            return; 
        }
    }

    // If no special link is found, show the Home Screen
    switchView('view-start');
});


// PASTE THIS AT THE ABSOLUTE BOTTOM OF YOUR SCRIPT
(function() {
    const params = new URLSearchParams(window.location.search);
    const resValue = params.get('res');

    if (resValue && resValue.includes(':')) {
        const [teacher, exam] = resValue.split(':');
        
        // 1. Switch View
        switchView('view-public-results');

        // 2. Fill Inputs
        const tIn = document.getElementById('res-t-id');
        const eIn = document.getElementById('res-e-id');
        if(tIn) tIn.value = decodeURIComponent(teacher);
        if(eIn) eIn.value = decodeURIComponent(exam);

        // 3. Load Data
        setTimeout(() => {
            if (typeof loadPublicBoard === 'function') loadPublicBoard();
        }, 500);
    } else {
        // Only show start if it's not a QR link
        switchView('view-start');
    }
})();


function filterMonitorTable() {
    const query = document.getElementById('student-search').value.toLowerCase();
    
    // 1. Filter the Main Table (Your existing logic)
    const tableRows = document.querySelectorAll('#monitor-body tr');
    tableRows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(query) ? '' : 'none';
    });

    // 2. Filter the Real-Time Feed Sidebar
    // We look for the 'data-student' attribute we added to each feed item
    const feedItems = document.querySelectorAll('#realtime-feed .feed-item');
    feedItems.forEach(item => {
        const studentName = item.getAttribute('data-student').toLowerCase();
        
        // If the student's name in the feed matches the search, show it
        if (studentName.includes(query)) {
            item.style.setProperty('display', 'block', 'important');
        } else {
            item.style.setProperty('display', 'none', 'important');
        }
    });
}
function listenToFeed(examId) {
    const feed = document.getElementById('realtime-feed');
    if(!feed) return;

    feed.innerHTML = ""; 
    db.ref(`logs/${currentTeacher}/${examId}`).off(); 

    db.ref(`logs/${currentTeacher}/${examId}`).on('child_added', studentSnap => {
        const sName = studentSnap.key;
        
        studentSnap.ref.on('child_added', logSnap => {
            const data = logSnap.val();
            
            console.log("Realtime Feed Data:", data);

            const div = document.createElement('div');
            
            // --- NECESSARY CHANGES FOR SEARCHING ---
            div.className = "feed-item";             // 1. Give it a class to find
            div.setAttribute('data-student', sName); // 2. Store the name for filtering
            // ---------------------------------------

            div.style = "padding: 8px; border-bottom: 1px solid #ddd; background: aqua; margin-bottom: 5px; border-radius: 4px; border-left: 4px solid var(--primary); animation: fadeIn 0.3s;";
            
            const questionNum = data.qNum || "Unknown";
            const studentAns = data.answer || "No selection";
            const actionTime = data.time || "--:--";

            div.innerHTML = `
                <strong>${sName}</strong> ‚Üí 
                <b>Q${questionNum}: ${studentAns}</b> 
                <br><small style="color:#999">${actionTime}</small>
            `;
            
            // Apply current search filter immediately if teacher is already searching
            const query = document.getElementById('student-search').value.toLowerCase();
            if (query && !sName.toLowerCase().includes(query)) {
                div.style.display = 'none';
            }

            feed.prepend(div);
            if(feed.children.length > 30) feed.lastChild.remove();
        });
    });
}




// we can delete this tab any time because it is having issues

document.addEventListener("visibilitychange", () => {
   
    if (document.visibilityState === "hidden") {
        
      
        const examPaperView = document.getElementById('view-paper');
        const isExamActive = examPaperView && examPaperView.style.display === 'block';

        if (typeof stState !== 'undefined' && stState && !stState.done && isExamActive) {
            
            stState.switches = (stState.switches || 0) + 1;
            
           
            db.ref(`live/${stState.teacher}/${stState.id}/${stState.name}`).update({
                tabSwitches: stState.switches
            });

            if (stState.switches >= 3) {
                alert("Test terminated due to multiple tab switches.");
                finishTest(); 
            } else {
                alert(`Warning ${stState.switches}/3: If you switch tabs again, your test will be submitted automatically!`);
            }
        }
    }
});




// Replace with your actual OpenAI Key from https://platform.openai.com/
// const OPENAI_API_KEY = "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"; 

// async function getGptGrade(question, studentAnswer, maxMarks) {
//     const url = "https://api.openai.com/v1/chat/completions";
    
//     const requestPayload = {
//         model: "gpt-4o-mini", // Fast and very cheap for grading
//         messages: [
//             {
//                 role: "system",
//                 content: "You are a teacher grading a student exam. Return only valid JSON."
//             },
//             {
//                 role: "user",
//                 content: `Grade this student answer fairly.
//                 Question: "${question}"
//                 Student Answer: "${studentAnswer}"
//                 Max Marks: ${maxMarks}
//                 Return ONLY this JSON format: {"score": number, "explanation": "string"}`
//             }
//         ],
//         response_format: { "type": "json_object" } // Forces GPT to return perfect JSON
//     };

//     try {
//         const response = await fetch(url, {
//             method: "POST",
//             headers: { 
//                 "Content-Type": "application/json",
//                 "Authorization": `Bearer ${OPENAI_API_KEY}`
//             },
//             body: JSON.stringify(requestPayload)
//         });

//         const data = await response.json();

//         if (data.error) {
//             console.error("GPT API Error:", data.error.message);
//             return null;
//         }

//         const resultText = data.choices[0].message.content;
//         const parsed = JSON.parse(resultText);
        
//         return {
//             score: Number(parsed.score) || 0,
//             explanation: parsed.explanation || ""
//         };

//     } catch (error) {
//         console.error("AI Logic Error:", error);
//         return null;
//     }
// }





// // 1. Get your free key from https://console.groq.com/keys
// const GROQ_API_KEY = "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"; 

// // The actual AI function
// async function getGroqGrade(question, studentAnswer, maxMarks) {
//     const url = "https://api.groq.com/openai/v1/chat/completions";
    
//     const requestPayload = {
//         model: "llama-3.3-70b-versatile", // Powerful & Free
//         messages: [
//             {
//                 role: "system",
//                 content: "You are a teacher grading a student exam. Return ONLY valid JSON."
//             },
//             {
//                 role: "user",
//                 content: `Grade this student answer fairly.
//                 Question: "${question}"
//                 Student Answer: "${studentAnswer}"
//                 Max Marks: ${maxMarks}
//                 Return ONLY JSON: {"score": number, "explanation": "string"}`
//             }
//         ],
//         response_format: { "type": "json_object" } 
//     };

//     try {
//         const response = await fetch(url, {
//             method: "POST",
//             headers: { 
//                 "Content-Type": "application/json",
//                 "Authorization": `Bearer ${GROQ_API_KEY}`
//             },
//             body: JSON.stringify(requestPayload)
//         });

//         const data = await response.json();
//         if (data.error) {
//             console.error("Groq Error:", data.error.message);
//             return null;
//         }

//         const resultText = data.choices[0].message.content;
//         return JSON.parse(resultText);
//     } catch (error) {
//         console.error("AI Logic Error:", error);
//         return null;
//     }
// }







// // The loop function
// async function bulkAiGrade() {
//     let examId = document.getElementById('mon-id').innerText.trim();
//     if (!examId || examId === "...") return alert("Open Monitor First.");

//     const studentsRef = db.ref(`live/${currentTeacher}/${examId}`);
//     const snap = await studentsRef.once('value');
//     const students = snap.val();
    
//     if (!students) return alert("No students found.");
//     const studentNames = Object.keys(students).filter(name => students[name].needsGrading);

//     for (let i = 0; i < studentNames.length; i++) {
//         const name = studentNames[i];
//         const s = students[name];
//         let totalAiMarks = 0;

//         for (let qIdx = 0; qIdx < currentExam.questions.length; qIdx++) {
//             const q = currentExam.questions[qIdx];
//             if (q.type === 'long') {
//                 const studentAns = (s.ans && s.ans[qIdx]) ? s.ans[qIdx] : "No Answer";
                
//                 // FIXED: Changed getGptGrade to getGroqGrade
//                 let result = await getGroqGrade(q.text, studentAns, q.marks || 10);
                
//                 if (!result) {
//                     console.log("Retrying in 5 seconds...");
//                     await new Promise(r => setTimeout(r, 5000));
//                     result = await getGroqGrade(q.text, studentAns, q.marks || 10);
//                 }

//                 if (result && typeof result.score === 'number') {
//                     totalAiMarks += result.score;
//                 } else {
//                     totalAiMarks += 0; 
//                 }
                
//                 // Small 1.5s delay to respect free rate limits
//                 await new Promise(r => setTimeout(r, 1500)); 
//             }
//         }

//         const finalScore = (s.mcqScore || 0) + totalAiMarks;
//         const totalPossible = s.totalPossible || 100;
//         const passLimit = currentExam.config.passLimit || 40;
//         const percentage = (finalScore / totalPossible) * 100;
//         const passStatus = percentage >= passLimit ? "Pass" : "Fail";

//         // await studentsRef.child(name).update({
//         //     score: finalScore,
//         //     status: passStatus,
//         //     needsGrading: false,
//         //     aiGraded: true
//         // });
//         // ... existing code inside the student loop ...
// await studentsRef.child(name).update({
//     score: finalScore,
//     status: passStatus,
//     needsGrading: false,
//     aiGraded: true,
//     aiFeedback: result.explanation // ADD THIS LINE to save the feedback
// });

//         console.log(`‚úÖ Updated ${name}: Score ${finalScore}`);
//     }
//     alert("Grading Finished!");
// }









// // 1. Get your free key from https://console.groq.com/keys
 const GROQ_API_KEY = "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"; 

// // The actual AI function
// async function getGroqGrade(question, studentAnswer, maxMarks) {
//     const url = "https://api.groq.com/openai/v1/chat/completions";
    
//     // Calculate word count
//     const wordCount = studentAnswer.trim().split(/\s+/).filter(word => word.length > 0).length;
    
//     // Setting up the Word Count logic for the AI
//     let lengthInstruction = "";
//     if (wordCount < 200) {
//         lengthInstruction = `STRICT RULE: The answer is only ${wordCount} words (Short). Even if perfectly correct, the MAXIMUM score allowed is 3 out of ${maxMarks}.`;
//     } else {
//         lengthInstruction = `The answer is ${wordCount} words (Long). You have full freedom to give any score from 0 to ${maxMarks}. Do not give full marks automatically; grade based on quality and depth.`;
//     }

//     const requestPayload = {
//         model: "llama-3.3-70b-versatile",
//         messages: [
//             {
//                 role: "system",
//                 content: "You are a professional examiner. Return ONLY valid JSON."
//             },
//             {
//                 role: "user",
//                 content: `Grade this student answer.
//                 Question: "${question}"
//                 Student Answer: "${studentAnswer}"
//                 Max Marks for this question: ${maxMarks}

//                 ${lengthInstruction}

//                 Return ONLY JSON format: {"score": number, "explanation": "string"}`
//             }
//         ],
//         response_format: { "type": "json_object" } 
//     };

//     try {
//         const response = await fetch(url, {
//             method: "POST",
//             headers: { 
//                 "Content-Type": "application/json",
//                 "Authorization": `Bearer ${GROQ_API_KEY}`
//             },
//             body: JSON.stringify(requestPayload)
//         });

//         const data = await response.json();
//         if (data.error) {
//             console.error("Groq Error:", data.error.message);
//             return null;
//         }

//         const resultText = data.choices[0].message.content;
//         return JSON.parse(resultText);
//     } catch (error) {
//         console.error("AI Logic Error:", error);
//         return null;
//     }
// }

// // The loop function
// async function bulkAiGrade() {
//     let examId = document.getElementById('mon-id').innerText.trim();
//     if (!examId || examId === "...") return alert("Open Monitor First.");

//     const studentsRef = db.ref(`live/${currentTeacher}/${examId}`);
//     const snap = await studentsRef.once('value');
//     const students = snap.val();
    
//     if (!students) return alert("No students found.");
//     const studentNames = Object.keys(students).filter(name => students[name].needsGrading);

//     for (let i = 0; i < studentNames.length; i++) {
//         const name = studentNames[i];
//         const s = students[name];
//         let totalAiMarks = 0;
//         let allFeedback = ""; // Fixed: We collect feedback here

//         for (let qIdx = 0; qIdx < currentExam.questions.length; qIdx++) {
//             const q = currentExam.questions[qIdx];
//             if (q.type === 'long') {
//                 const studentAns = (s.ans && s.ans[qIdx]) ? s.ans[qIdx] : "No Answer";
                
//                 let result = await getGroqGrade(q.text, studentAns, q.marks || 10);
                
//                 if (!result) {
//                     console.log("Retrying in 5 seconds...");
//                     await new Promise(r => setTimeout(r, 5000));
//                     result = await getGroqGrade(q.text, studentAns, q.marks || 10);
//                 }

//                 if (result && typeof result.score === 'number') {
//                     totalAiMarks += result.score;
//                     // Store feedback for each question
//                     allFeedback += `Q${qIdx + 1}: ${result.explanation} `; 
//                 } else {
//                     totalAiMarks += 0; 
//                     allFeedback += `Q${qIdx + 1}: AI Error. `;
//                 }
                
//                 await new Promise(r => setTimeout(r, 1500)); 
//             }
//         }

//         const finalScore = (s.mcqScore || 0) + totalAiMarks;
//         const totalPossible = s.totalPossible || 100;
//         const passLimit = (currentExam.config && currentExam.config.passLimit) ? currentExam.config.passLimit : 40;
//         const percentage = (finalScore / totalPossible) * 100;
//         const passStatus = percentage >= passLimit ? "Pass" : "Fail";

//         // Fixed: Use the 'allFeedback' string we collected
//         await studentsRef.child(name).update({
//             score: finalScore,
//             status: passStatus,
//             needsGrading: false,
//             aiGraded: true,
//             aiFeedback: allFeedback
//         });

//         console.log(`‚úÖ Updated ${name}: Score ${finalScore}`);
//     }
//     alert("Grading Finished!");
// }








async function getGroqGrade(question, studentAnswer, maxMarks) {
    const url = "https://api.groq.com/openai/v1/chat/completions";
    const wordCount = studentAnswer.trim().split(/\s+/).filter(word => word.length > 0).length;
    
    let lengthInstruction = "";
    if (wordCount < 200) {
        lengthInstruction = `STRICT RULE: The answer is only ${wordCount} words. MAXIMUM score allowed is 3 out of ${maxMarks}.`;
    } else {
        lengthInstruction = `The answer is ${wordCount} words. Range: 0 to ${maxMarks} based on quality.`;
    }

    const requestPayload = {
        model: "llama-3.3-70b-versatile",
        messages: [
            {
                role: "system",
                content: "You are a professional examiner and supportive tutor. Return ONLY valid JSON."
            },
            {
                role: "user",
                content: `Grade this student answer.
                Question: "${question}"
                Student Answer: "${studentAnswer}"
                Max Marks: ${maxMarks}

                ${lengthInstruction}

                Return ONLY JSON format: {
                    "score": number, 
                    "explanation": "string",
                    "studyPlan": "Identify the student's weakness in this answer and suggest exactly what they should study to improve."
                }`
            }
        ],
        response_format: { "type": "json_object" } 
    };

    try {
        const response = await fetch(url, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Authorization": `Bearer ${GROQ_API_KEY}`
            },
            body: JSON.stringify(requestPayload)
        });
        const data = await response.json();
        return JSON.parse(data.choices[0].message.content);
    } catch (error) {
        console.error("AI Error:", error);
        return null;
    }
}





async function bulkAiGrade() {
    let examId = document.getElementById('mon-id').innerText.trim();
    if (!examId || examId === "...") return alert("Open Monitor First.");

    const studentsRef = db.ref(`live/${currentTeacher}/${examId}`);
    const snap = await studentsRef.once('value');
    const students = snap.val();
    
    if (!students) return alert("No students found.");
    const studentNames = Object.keys(students).filter(name => students[name].needsGrading);

    for (let i = 0; i < studentNames.length; i++) {
        const name = studentNames[i];
        const s = students[name];
        let totalAiMarks = 0;
        let allFeedback = ""; 
        let combinedStudyPlan = ""; // To store the suggestions

        for (let qIdx = 0; qIdx < currentExam.questions.length; qIdx++) {
            const q = currentExam.questions[qIdx];
            if (q.type === 'long') {
                const studentAns = (s.ans && s.ans[qIdx]) ? s.ans[qIdx] : "No Answer";
                let result = await getGroqGrade(q.text, studentAns, q.marks || 10);
                
                if (result && typeof result.score === 'number') {
                    totalAiMarks += result.score;
                    allFeedback += `Q${qIdx + 1}: ${result.explanation} | `;
                    combinedStudyPlan += `Target ${qIdx + 1}: ${result.studyPlan} \n`; 
                } else {
                    totalAiMarks += 0;
                }
                await new Promise(r => setTimeout(r, 1500)); 
            }
        }

        const finalScore = (s.mcqScore || 0) + totalAiMarks;
        const totalPossible = s.totalPossible || 100;
        const passLimit = (currentExam.config && currentExam.config.passLimit) ? currentExam.config.passLimit : 40;
        const percentage = (finalScore / totalPossible) * 100;
        const passStatus = percentage >= passLimit ? "Pass" : "Fail";

        await studentsRef.child(name).update({
            score: finalScore,
            status: passStatus,
            needsGrading: false,
            aiGraded: true,
            aiFeedback: allFeedback,
            aiStudyPlan: combinedStudyPlan // Saving to Firebase
        });
        console.log(`‚úÖ ${name} Graded`);
    }
    alert("Grading Finished!");
}

// Inside your code where you handle switching to the Monitor view






async function generateAiExam(event) {
    if(event) event.preventDefault();

    const subject = document.getElementById('ai-subject').value.trim();
    const mcqCount = parseInt(document.getElementById('ai-mcq-count').value) || 0;
    const longCount = parseInt(document.getElementById('ai-long-count').value) || 0;
    const passMarks = document.getElementById('ai-pass-marks').value || 40;
    const expiryInput = document.getElementById('ai-expiry').value; // Get datetime string

    if (!subject || (mcqCount === 0 && longCount === 0)) {
        return alert("Please fill in subject and question counts.");
    }

    const btn = event.target;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Generating...`;
    btn.disabled = true;

    // Convert expiry date to a Timestamp number for your logic check
    const expiryTimestamp = expiryInput ? new Date(expiryInput).getTime() : Date.now() + 86400000;

    const prompt = `Generate a ${document.getElementById('ai-difficulty').value} level exam about ${subject}. 
    Include ${mcqCount} MCQs and ${longCount} long questions. 
    Return ONLY JSON: {"questions": [{"type": "mcq", "text": "...", "options": ["A","B","C","D"], "correct": 0, "marks": 2}, {"type": "long", "text": "...", "marks": 10}]}`;

    try {
        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json", 
                "Authorization": `Bearer ${GROQ_API_KEY}` 
            },
            body: JSON.stringify({
                model: "llama-3.3-70b-versatile",
                messages: [{ role: "user", content: prompt }],
                response_format: { "type": "json_object" }
            })
        });

        const data = await response.json();
        const generated = JSON.parse(data.choices[0].message.content);

        // CREATE TEST ID
        const aiTestId = "AI-" + Math.floor(1000 + Math.random() * 9000);

        // SAVE TO THE PATH YOUR LISTENER EXPECTS
        await db.ref(`teachers/${currentTeacher}/exams/${aiTestId}`).set({
            questions: generated.questions,
            config: {
                expiry: expiryTimestamp, // Numeric timestamp for your 'expired' check
                passLimit: parseInt(passMarks),
                duration: 60
            }
        });

        alert("Test Published! Code: " + aiTestId);
        // Reset fields
        document.getElementById('ai-subject').value = "";
        
    } catch (err) {
        console.error(err);
        alert("AI Error. Please try again.");
    } finally {
        btn.innerHTML = "üöÄ Generate & Publish Test";
        btn.disabled = false;
    }
}





</script>


<!-- <div id="reviewModal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter:blur(4px);">
    <div style="background:white; margin:5% auto; padding:25px; width:90%; max-width:550px; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <h2 style="color:#2c3e50; margin-top:0; border-bottom:2px solid #eee; padding-bottom:10px;">üéì Performance Review</h2>
        
        <div style="margin:20px 0;">
            <p><strong>Feedback:</strong></p>
            <p id="revFeedback" style="background:#f9f9f9; padding:10px; border-radius:8px; font-size:14px; color:#555;"></p>
        </div>

        <div style="margin:20px 0; background:#e3f2fd; padding:15px; border-radius:8px; border-left:5px solid #2196f3;">
            <p style="color:#0d47a1; margin-top:0;"><strong>üìö Personal Study Plan:</strong></p>
            <p id="revStudyPlan" style="font-size:14px; color:#0d47a1; white-space: pre-wrap;"></p>
        </div>

        <button onclick="document.getElementById('reviewModal').style.display='none'" 
                style="width:100%; padding:12px; background:#2c3e50; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">Close Review</button>
    </div>
</div> -->







<script>
    // function openReview(feedback, plan) {
    //     document.getElementById('revFeedback').innerText = feedback;
    //     document.getElementById('revStudyPlan').innerText = plan || "Great job! Keep practicing.";
    //     document.getElementById('reviewModal').style.display = 'block';
    // }
//     function openReview(feedback, plan) {
//     // We use .innerText to ensure the text displays correctly even if it has symbols
//     document.getElementById('revFeedback').innerText = feedback;
//     document.getElementById('revStudyPlan').innerText = plan;
//     document.getElementById('reviewModal').style.display = 'block';
// }

function openReview(feedback, plan) {
    document.getElementById('revFeedback').innerText = feedback;
    document.getElementById('revStudyPlan').innerText = plan || "Great job! Keep practicing.";
    document.getElementById('reviewModal').style.display = 'block';
    // Prevent scrolling of the background page when modal is open
    document.body.style.overflow = 'hidden';
}

function closeReview() {
    document.getElementById('reviewModal').style.display = 'none';
    // Re-enable scrolling
    document.body.style.overflow = 'auto';
}

// This function detects if the click was on the DARK background
function closeOnOutsideClick(event) {
    const modalContent = document.getElementById('modalContent');
    // If the click happened on the background (reviewModal) and NOT the content box
    if (event.target.id === "reviewModal") {
        closeReview();
    }
}



</script>
</script>
<!-- <div id="reviewModal" onclick="closeOnOutsideClick(event)" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter:blur(4px); transition: 0.3s;">
    <div id="modalContent" style="background:white; margin:5% auto; padding:25px; width:90%; max-width:550px; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.5); position:relative;">
        
        <span onclick="closeReview()" style="position:absolute; right:20px; top:15px; font-size:24px; cursor:pointer; color:#888;">&times;</span>

        <h2 style="color:#2c3e50; margin-top:0; border-bottom:2px solid #eee; padding-bottom:10px;">üéì Performance Review</h2>
        
        <div style="margin:20px 0;">
            <p><strong>AI Feedback:</strong></p>
            <p id="revFeedback" style="background:#f9f9f9; padding:10px; border-radius:8px; font-size:14px; color:#555; white-space: pre-wrap;"></p>
        </div>

        <div style="margin:20px 0; background:#e3f2fd; padding:15px; border-radius:8px; border-left:5px solid #2196f3;">
            <p style="color:#0d47a1; margin-top:0;"><strong>üìö Personal Study Plan:</strong></p>
            <p id="revStudyPlan" style="font-size:14px; color:#0d47a1; white-space: pre-wrap;"></p>
        </div>

        <button onclick="closeReview()" style="width:100%; padding:12px; background:#2c3e50; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; transition: 0.2s;">Close</button>
    </div>
</div> -->

<!-- <div id="reviewModal" onclick="closeOnOutsideClick(event)" style="
    display:none; 
    position:fixed; 
    z-index:99999; 
    left:0; 
    top:0; 
    width:100%; 
    height:100%; 
    background: rgba(0, 0, 0, 0.85); /* This is the DARK BACKGROUND */
    backdrop-filter: blur(8px);
">
    <div id="modalContent" style="
        background: white; 
        margin: 10% auto; 
        padding: 30px; 
        width: 90%; 
        max-width: 500px; 
        border-radius: 15px; 
        position: relative; /* Allows X to be positioned inside */
        box-shadow: 0px 0px 20px rgba(255,255,255,0.2);
    ">
        
        <span onclick="closeReview()" style="
            position: absolute; 
            right: 15px; 
            top: 10px; 
            font-size: 30px; 
            font-weight: bold; 
            color: #ff4d4d; /* Bright Red so you can see it */
            cursor: pointer;
            line-height: 1;
        ">&times;</span>

        <h2 style="margin-top:0; color:#333;">üéì AI Review</h2>
        <hr>
        
        <div style="margin:15px 0;">
            <p><strong>Feedback:</strong></p>
            <p id="revFeedback" style="color:#555; font-size:14px; background:#f4f4f4; padding:10px; border-radius:5px;"></p>
        </div>

        <div style="margin:15px 0; background:#e8f4fd; padding:10px; border-radius:5px;">
            <p style="color:#0056b3;"><strong>üìö Study Plan:</strong></p>
            <p id="revStudyPlan" style="color:#0056b3; font-size:14px;"></p>
        </div>

        <button onclick="closeReview()" style="width:100%; padding:10px; background:#333; color:white; border:none; border-radius:5px; cursor:pointer;">Close</button>
    </div>
</div> -->

<div id="reviewModal" onclick="closeOnOutsideClick(event)" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter:blur(4px); transition: 0.3s;">
    <div id="modalContent" style="background:white; margin:2% auto; padding:25px; width:90%; max-width:550px; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.5); position:relative; max-height: 90vh; display: flex; flex-direction: column;">
        
        <span onclick="closeReview()" style="position:absolute; right:20px; top:15px; font-size:24px; cursor:pointer; color:#888; z-index: 10;">&times;</span>
        <h2 style="color:#2c3e50; margin-top:0; border-bottom:2px solid #eee; padding-bottom:10px; flex-shrink: 0;">üéì Performance Review</h2>
        
        <div style="overflow-y: auto; flex-grow: 1; padding-right: 10px; margin: 15px 0;">
            <div style="margin-bottom:20px;">
                <p><strong>AI Feedback:</strong></p>
                <p id="revFeedback" style="background:#f9f9f9; padding:15px; border-radius:8px; font-size:14px; color:#555; white-space: pre-wrap; line-height: 1.6;"></p>
            </div>

            <div style="background:#e3f2fd; padding:15px; border-radius:8px; border-left:5px solid #2196f3;">
                <p style="color:#0d47a1; margin-top:0;"><strong>üìö Personal Study Plan:</strong></p>
                <p id="revStudyPlan" style="font-size:14px; color:#0d47a1; white-space: pre-wrap; line-height: 1.6;"></p>
            </div>
        </div>

        <button onclick="closeReview()" style="width:100%; padding:12px; background:#2c3e50; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; transition: 0.2s; flex-shrink: 0;">Close</button>
    </div>
</div>
</body>
</html>

