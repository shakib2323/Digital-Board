<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduFlow Ultimate-ZinqFitness | Pro Teaching Board</title>
    <!-- <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
     -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <style> 
        :root {
            --primary: #6366f1;
             --bg-dark: #0f172a; 
             --board-bg: #1e1e1e;
            --line-color: #333;
             --sidebar-w: 75px;
              --admin-card: #1e293b;
        }
        * {
             margin: 0;
              padding: 0; 
              box-sizing: border-box;
               font-family: 'Inter', sans-serif; }
        body { 
            background: var(--bg-dark);
             color: white;
             }

        /* NEW MOBILE HEADER STYLE */
        .mobile-header {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0; left: 0; width: 100%;
            height: 60px;
            background: #1e293b;
            z-index: 3000;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 10px;
            overflow-x: auto;
            border-bottom: 1px solid #334155;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .mobile-header::-webkit-scrollbar { display: none; }

        .mobile-header button, .mobile-header label {
            background: #334155;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar {
            position: fixed; 
            left: 0; top: 0;
             height: 100%;
              width: var(--sidebar-w);
            background: #000; 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            padding-top: 25px;
             gap: 35px; 
             border-right: 1px solid #334155; 
             z-index: 2000;
        }
        .sidebar i { 
            font-size: 1.5rem;
             color: #94a3b8; 
             cursor: pointer; 
             transition: 0.3s; }
        .sidebar i.active {
             color: var(--primary);
             }

        .main-container { 
            margin-left: var(--sidebar-w);
             min-height: 100vh;
              position: relative; }

        .board-container {
            width: 100%; min-height: 100vh; background-color: var(--board-bg);
            background-image: linear-gradient(var(--line-color) 1px, transparent 1px);
            background-size: 100% 40px; position: relative; padding-top: 80px;
        }
        #teachingBoard { cursor: crosshair; display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        
        #teacherEditor {
            position: absolute; top: 80px; left: 0; width: 100%; min-height: 100vh;
            z-index: 2; padding: 20px; outline: none; background: transparent;
            color: white; font-size: 20px; line-height: 40px; pointer-events: auto;
        }

        .toolbar-top {
            position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
            background: rgba(30,41,59,0.95); padding: 10px 25px; border-radius: 12px;
            display: flex; gap: 12px; align-items: center; z-index: 1500; border: 1px solid #475569;
            flex-wrap: wrap; justify-content: center;
        }
        .toolbar-top button, .toolbar-top label { background: #334155; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 14px; }

        .student-paper {
            background: white; color: black; padding: 60px; width: 90%; max-width: 900px;
            margin: 40px auto; min-height: 100vh; position: relative;
            background-image: repeating-linear-gradient(white 0px, white 34px, #e5e7eb 35px);
            line-height: 35px; font-size: 18px; outline: none; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .admin-view { padding: 40px; }
        .data-card {
            background: var(--admin-card); padding: 25px; border-radius: 12px;
            margin-bottom: 25px; border-left: 5px solid var(--primary);
        }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .stats-bar { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-box { background: #334155; padding: 15px; border-radius: 8px; flex: 1; text-align: center; border: 1px solid var(--primary); }

        .img-adjustable { position: absolute; border: 2px dashed var(--primary); cursor: move; z-index: 500; }
        .image-controls-panel {
            position: fixed; bottom: 30px; right: 30px; background: #1e293b; padding: 20px;
            border-radius: 15px; display: none; z-index: 3000; box-shadow: 0 0 20px black;
        }
        .grid-ctrl { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .grid-ctrl button { padding: 10px; border: none; background: #334155; color: white; cursor: pointer; border-radius: 5px; }

        #toast { position: fixed; top: 20px; right: -300px; background: var(--primary); color: white; padding: 15px 30px; border-radius: 10px; transition: 0.5s; z-index: 5000; font-weight: bold; }
        .hidden { display: none !important; }
        .q-text { color: red; font-weight: bold; }
        .a-text { color: inherit; font-weight: normal; }
        
        .voice-btn { background: #ef4444 !important; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }


html, body {
    overflow-x: hidden;
}

#teachingBoard {
    width: 100% !important;
}

/* =========================
   MOBILE (<= 768px)
   ========================= */
@media (max-width: 768px) {
    .mobile-header {
        display: flex; 
    }

    .toolbar-top {
        display: none;
    }

    .sidebar {
        flex-direction: row;
        width: 100%;
        height: 60px;
        bottom: 0;
        top: auto;
        justify-content: space-around;
        padding: 0;
        border-right: none;
        border-top: 1px solid #334155;
    }

    .main-container {
        margin-left: 0;
        margin-bottom: 60px;
        margin-top: 60px; 
    }

    .board-container {
        padding-top: 10px;
    }

    #teacherEditor {
        top: 10px;
    }

    .student-paper {
        width: 95%;
        padding: 25px;
        margin-top: 20px;
    }
}

@media (min-width: 769px) {
    .mobile-header {
        display: none !important; 
    }
}


.student-paper {
    background: white; 
    color: black; 
    padding: 60px; 
    width: 90%; 
    max-width: 900px;
    margin: 40px auto; 
    min-height: 100vh; 
    height: auto;      
    overflow: visible; 
    position: relative;
    background-image: repeating-linear-gradient(white 0px, white 34px, #e5e7eb 35px);
    line-height: 35px; 
    font-size: 18px; 
    outline: none; 
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    word-wrap: break-word;
}



/* Animated Mood Icons */
.mood-selector label {
    transition: all 0.3s ease;
    padding: 10px;
    border-radius: 50%;
    display: inline-block;
    filter: grayscale(100%); /* Start greyed out */
    opacity: 0.6;
}

.mood-selector label:hover {
    transform: scale(1.2);
    opacity: 1;
}

.mood-selector input[type="radio"]:checked + span,
.mood-selector input[type="radio"]:checked ~ i, /* if using icons */
.mood-selector label:has(input:checked) {
    filter: grayscale(0%);
    opacity: 1;
    transform: scale(1.4);
    background: rgba(99, 102, 241, 0.1);
    box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
}



/* ADMIN PANEL RESPONSIVENESS */
@media (max-width: 768px) {
    .admin-view {
        padding: 15px; /* Less padding on small screens */
    }

    .admin-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }

    .admin-header h1 {
        font-size: 1.5rem;
    }

    /* Stack stats vertically on mobile */
    .stats-bar {
        flex-direction: column;
        gap: 10px !important;
    }

    /* Make buttons full width on small mobile */
    .admin-header button, #adminSearch {
        width: 100%;
        margin-bottom: 5px;
    }

    /* Adjust the individual student data cards */
    .data-card {
        padding: 15px;
    }

    /* Action buttons in the footer of the admin view */
    .stats-bar + div {
        flex-direction: column;
        width: 100%;
    }
    
    .stats-bar + div button {
        width: 100%;
    }
}





/* RESPONSIVE EDITOR PAD */
.responsive-editor {
    width: 95% !important;
    margin: 10px auto !important;
    padding: 30px !important; /* Smaller padding for mobile */
    font-size: 16px !important;
    line-height: 32px !important;
    background-size: 100% 32px !important; /* Lines match text */
}

/* TABLET & DESKTOP ADJUSTMENT */
@media (min-width: 768px) {
    .responsive-editor {
        width: 90% !important;
        max-width: 900px !important;
        padding: 60px !important;
        font-size: 18px !important;
        line-height: 35px !important;
        background-size: 100% 35px !important;
    }
}

/* Ensure images inside the editor don't break the layout */
#studentEditor img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
}



/* FOCUS MODE OVERRIDES */
body.focus-active .sidebar, 
body.focus-active #student-toolbar, 
body.focus-active #student-workspace-ui {
    display: none !important;
}

body.focus-active .main-container {
    margin: 0 !important;
    padding: 0 !important;
}

body.focus-active .student-paper {
    margin: 0 auto !important;
    width: 100% !important;
    max-width: 1000px !important;
    box-shadow: none !important;
    min-height: 100vh !important;
}

/* RESPONSIVE EDITOR PAD (From previous step) */
.responsive-editor {
    width: 95% !important;
    margin: 10px auto;
    padding: 30px !important;
    font-size: 16px;
    line-height: 32px;
    background-size: 100% 32px;
    transition: all 0.3s ease;
}

@media (min-width: 768px) {
    .responsive-editor {
        width: 90% !important;
        max-width: 900px;
        padding: 60px !important;
        font-size: 18px;
        line-height: 35px;
        background-size: 100% 35px;
    }
}



/* Force the shared view to the top */
#section-single-view:not(.hidden) {
    display: block !important;
    visibility: visible !important;
    z-index: 99999 !important;
}

/* Hide everything else when the shared view is active */
body.sharing-active .sidebar, 
body.sharing-active .mobile-header,
body.sharing-active .toolbar-top {
    display: none !important;
}


.admin-btn {
    color: white; 
    border: none; 
    padding: 6px 10px; 
    border-radius: 4px; 
    cursor: pointer;
    font-size: 12px;
}

.responsive-paper-wrapper.zoomed {
    overflow-x: auto !important;
    cursor: zoom-out !important;
}
.responsive-paper-wrapper.zoomed .scaler-engine {
    transform: scale(1) !important;
}








@keyframes pulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
    70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
}
.pulse-animation {
    animation: pulse 2s infinite;
}
    </style>
</head>
<body>

    <header class="mobile-header no-print">
        <button onclick="clearCanvas()" style="color:#ef4444;"><i class="fas fa-trash"></i></button>
        <label for="teachImgMob"><i class="fas fa-image"></i></label>
        <input type="file" id="teachImgMob" hidden accept="image/*" onchange="handleImage(this)">
        <button onclick="changeFontSize(-1)"><i class="fas fa-minus"></i></button>
        <button onclick="changeFontSize(1)"><i class="fas fa-plus"></i></button>
        
        <div style="display:flex; align-items:center; gap:5px; background:#475569; padding:5px; border-radius:5px;">
            <span>H</span><input type="color" value="#ffff00" onchange="styleSelectedText('hiliteColor', this.value)" style="width:20px;">
            <span>T</span><input type="color" value="#ffffff" onchange="styleSelectedText('foreColor', this.value)" style="width:20px;">
        </div>
        
        <button onclick="addTeacherText('A')" style="font-weight:bold;">A</button>
        <button onclick="addTeacherText('Q')" style="color:red; font-weight:bold;">Q</button>
        <button onclick="setMode('pen')"><i class="fas fa-pen"></i></button>
        <button onclick="setMode('rect')"><i class="fas fa-draw-polygon"></i></button>
        <input type="color" id="teachColorMob" value="#ffffff" style="width:30px; height:30px; border-radius:50%; border:none;">
      
    </header>

    <div id="toast">New Update!</div>
    
    <nav class="sidebar no-print">
        <i class="fas fa-chalkboard-teacher active" id="nav-teacher" onclick="nav('teacher')" title="Teacher Board"></i>
        <i class="fas fa-edit" id="nav-student" onclick="nav('student')" title="Student Notes"></i>
        <i class="fas fa-user-shield" id="nav-admin" onclick="openAdmin()" title="Admin Control"></i>
        <i class="fas fa-file-pdf" onclick="downloadMasterPDF()" title="Download as PDF"></i>
        <a href="index12.html" style="text-decoration: none; color: white;"><h6>TakeTest</h6></a>
         
    </nav>
    
    <div class="main-container">
        <div id="section-teacher" class="view-div">
            <div class="toolbar-top no-print">
                <span title="Pen Color"><i class="fas fa-paint-brush"></i> <input type="color" id="teachColor" value="#ffffff"></span>
                <button onclick="setMode('pen')" title="Pen Mode"><i class="fas fa-pen"></i></button>
                <button onclick="setMode('rect')" title="Shape Mode"><i class="fas fa-draw-polygon"></i></button>
                <div style="width:1px; height:25px; background:#475569; margin:0 5px;"></div>
                <button onclick="addTeacherText('Q')" style="color:red; font-weight:bold;">Q</button>
                <button onclick="addTeacherText('A')" style="color:white; font-weight:bold;">A</button>
                <span title="Text Color">T <input type="color" id="textColorPicker" value="#ffffff" onchange="styleSelectedText('foreColor', this.value)"></span>
                <span title="Highlight">H <input type="color" id="textHilitePicker" value="#ffff00" onchange="styleSelectedText('hiliteColor', this.value)"></span>
                <button onclick="changeFontSize(1)" title="Increase Font"><i class="fas fa-plus"></i></button>
                <button onclick="changeFontSize(-1)" title="Decrease Font"><i class="fas fa-minus"></i></button>
                <div style="width:1px; height:25px; background:#475569; margin:0 5px;"></div>
                <label for="teachImg" style="cursor:pointer;"><i class="fas fa-image"></i></label>
                <input type="file" id="teachImg" hidden accept="image/*">
                <button onclick="clearCanvas()" style="color:#ef4444;"><i class="fas fa-trash"></i></button>

                
    <button onclick="generateQR()" title="Share Board"><i class="fas fa-qrcode"></i></button>

              </div>
            <div class="board-container" id="teacher-wrap">
                <canvas id="teachingBoard"></canvas>
                <div id="teacherEditor" contenteditable="true">Teacher: Click to type, or use Pen...created by Shakib Ali</div>
            </div>
        </div>

      





<div id="section-student" class="view-div hidden">
    <div id="student-toolbar" class="no-print" style="background:#1e293b; padding:10px; position:sticky; top:0; z-index:1000; display:flex; gap:8px; justify-content:center; border-bottom:1px solid #334155; flex-wrap: wrap; transition: all 0.3s ease; align-items: center;">
        <button onclick="addStyledText('Q')" style="background:red; color:white; border:none; padding:10px; min-width:60px; flex:1; border-radius:6px; cursor:pointer; font-size:13px; font-weight:bold;">Q</button>
        <button onclick="addStyledText('A')" style="background:black; color:white; border:none; padding:10px; min-width:60px; flex:1; border-radius:6px; cursor:pointer; font-size:13px; font-weight:bold;">A</button>
        
        <button id="studentShapeBtn" onclick="toggleStudentDrawMode()" style="background:#f87171; color:white; border:none; padding:10px; min-width:110px; flex:1; border-radius:6px; cursor:pointer; font-size:13px;">
            <i class="fas fa-draw-polygon"></i> Draw Shape
        </button>

        <button onclick="clearAllShapes()" style="background:#475569; color:white; border:none; padding:10px; width:45px; border-radius:6px; cursor:pointer;" title="Clear Drawing">
            <i class="fas fa-eraser"></i>
        </button>

        <button id="voiceStartBtn" onclick="startVoiceRecognition('studentEditor')" style="background:#6366f1; color:white; border:none; padding:10px; min-width:110px; flex:1; border-radius:6px; cursor:pointer; font-size:13px;"><i class="fas fa-microphone"></i> Voice</button>
        
        <label for="studentImgInp" style="background:var(--primary); color:white; padding:10px; min-width:100px; flex:1; border-radius:6px; cursor:pointer; text-align:center; font-size:13px;">
            <i class="fas fa-image"></i> Image
        </label>
        <input type="file" id="studentImgInp" hidden accept="image/*">
        
        <button id="saveBtn" onclick="saveSession()" style="background:#10b981; color:white; border:none; padding:10px; min-width:110px; flex:1; border-radius:6px; cursor:pointer; font-size:13px; font-weight:bold;">Save Data</button>
        
        <button onclick="toggleFocusMode()" id="focusBtn" title="Focus Mode" style="background:#475569; color:white; border:none; padding:10px; width:45px; border-radius:6px; cursor:pointer;"><i class="fas fa-expand"></i></button>
        <button onclick="generateQR()" title="Share Board" style="background:#475569; color:white; border:none; padding:10px; width:45px; border-radius:6px; cursor:pointer;"><i class="fas fa-qrcode"></i></button>
        


        <label for="studentPdfInp" style="background:#f59e0b; color:white; padding:10px; min-width:110px; flex:1; border-radius:6px; cursor:pointer; text-align:center; font-size:13px; font-weight:bold;">
    <i class="fas fa-file-pdf"></i> Upload PDF
</label>
<input type="file" id="studentPdfInp" hidden accept="application/pdf" onchange="uploadStudentPdf()">
    </div>

    <div id="student-workspace-ui" style="max-width: 900px; margin: 10px auto; padding: 0 10px; transition: opacity 0.3s ease;">
        <div style="display:flex; justify-content:flex-end; margin-bottom: 10px;">
            <span id="active-timer-display" style="font-size: 11px; color: #1e293b; font-weight: bold; background: #fef3c7; padding: 6px 12px; border-radius: 20px; border: 1px solid #fcd34d; white-space: nowrap;">
                <i class="fas fa-stopwatch"></i> Active Work: 0m 0s
            </span>
        </div>

        <div id="collab-container" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                <h4 style="margin: 0; color: #1e293b; font-size: 0.95rem;"><i class="fas fa-users"></i> 2-in-1 Live Mode</h4>
                <span id="partner-status" style="color: #10b981; font-weight: bold;">Initializing...</span>
                


                <div id="share-area" style="display:none; margin: 15px auto; padding: 16px; background: rgba(255, 255, 255, 0.9); border: 1px solid #e2e8f0; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); max-width: 500px; width: 95%;">
    
    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
        <div style="background: #6366f1; width: 4px; height: 16px; border-radius: 2px;"></div>
        <p style="margin:0; font-size: 14px; font-weight: 700; color: #1e293b; letter-spacing: -0.01em;">Invite Partner</p>
    </div>
    
    <div style="display: flex; flex-direction: column; gap: 12px;">
        <div style="display: flex; background: #f1f5f9; border-radius: 10px; padding: 4px; border: 1px solid #cbd5e1;">
            <input type="text" id="collabUrl" readonly 
                style="flex: 1; font-size: 12px; padding: 8px 12px; border: none; background: transparent; color: #475569; outline: none; min-width: 0;" 
                value="Generating link...">
            <button onclick="copyCollabLink()" 
                style="background: #6366f1; color: white; border: none; padding: 6px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s; white-space: nowrap;">
                <i class="fas fa-copy"></i> Copy
            </button>
        </div>

        <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
            <button onclick="shareToWhatsApp()" style="flex: 1; min-width: 100px; background: #25D366; color: white; border: none; padding: 10px; border-radius: 10px; cursor: pointer; font-size: 11px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px;">
                <i class="fab fa-whatsapp" style="font-size: 14px;"></i> WhatsApp
            </button>
            
            <button onclick="shareToEmail()" style="flex: 1; min-width: 100px; background: #ef4444; color: white; border: none; padding: 10px; border-radius: 10px; cursor: pointer; font-size: 11px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px;">
                <i class="fas fa-envelope" style="font-size: 14px;"></i> Email
            </button>

            <button id="nativeShareBtn" onclick="shareNative()" style="flex: 1; min-width: 100px; background: #1e293b; color: white; border: none; padding: 10px; border-radius: 10px; cursor: pointer; font-size: 11px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px;">
                <i class="fas fa-share-alt" style="font-size: 14px;"></i> More
            </button>
        </div>
    </div>
</div>


                <!-- <div id="collaboration-lobby" style="background: #ec2c2c; padding: 15px; border-radius: 12px; margin-top: 10px; border: 1px solid #e2e8f0;">
    <h4 style="margin: 0 0 10px 0;"><i class="fas fa-users"></i> Online Students</h4>
    <div id="user-list" style="max-height: 200px; overflow-y: auto;">
        <p style="font-size: 12px; color: #94a3b8;">Logging in to see active students...</p>
    </div>
</div> -->
<!-- <div id="lobby-container" style="margin: 15px auto; padding: 16px; background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; max-width: 500px; width: 95%; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
        <h5 style="margin: 0; font-size: 14px; color: #1e293b;"><i class="fas fa-users" style="color: #6366f1;"></i> Active Students</h5>
        <span id="online-count" style="background: #e0e7ff; color: #4338ca; font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: bold;">0 Online</span>
    </div>
    
    <div id="user-list" style="display: flex; flex-direction: column; gap: 8px;">
        <p style="font-size: 12px; color: #94a3b8; text-align: center; margin: 10px 0;">Looking for online students...</p>
    </div>
</div>

<div id="invite-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,0.2); z-index:10000; text-align:center; min-width:300px;">
    <h3>Collaboration Invite!</h3>
    <p id="invite-text"></p>
    <div style="display:flex; gap:10px; justify-content:center;">
        <button id="accept-btn" style="background:#10b981; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">Accept</button>
        <button onclick="document.getElementById('invite-modal').style.display='none'" style="background:#ef4444; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">Decline</button>
    </div>
</div> -->

<div id="advanced-collab-panel" style="margin: 15px auto; max-width: 500px; width: 95%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
    <div style="background: white; padding: 20px; border-radius: 20px; border: 1px solid #e2e8f0; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);">
        
        <h5 style="margin: 0 0 12px 0; font-size: 14px; color: #1e293b; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-book-open" style="color: #6366f1;"></i> What are you writing about?
        </h5>
        <div style="display: flex; gap: 8px; margin-bottom: 20px;">
            <input type="text" id="subjectInput" placeholder="e.g. Physics Notes, Creative Story..." 
                style="flex: 1; padding: 12px; border-radius: 12px; border: 1px solid #cbd5e1; font-size: 13px; outline: none; transition: border 0.3s;">
            <button onclick="handleCollabMode()" id="collabToggleBtn"
                style="background: #6366f1; color: white; border: none; padding: 0 20px; border-radius: 12px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                Go Live
            </button>
        </div>

        <div style="display: flex; align-items: center; justify-content: space-between; padding-top: 15px; border-top: 1px dashed #e2e8f0;">
            <h5 style="margin: 0; font-size: 13px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Active Students</h5>
            <span id="online-count" style="background: #ecfdf5; color: #059669; font-size: 11px; padding: 4px 12px; border-radius: 20px; font-weight: 800;">0 Online</span>
        </div>

        <div id="user-list" style="margin-top: 15px; display: flex; flex-direction: column; gap: 10px; max-height: 250px; overflow-y: auto;">
            <p style="text-align: center; color: #94a3b8; font-size: 12px; padding: 20px;">Enter your subject to join the lobby.</p>
        </div>
    </div>
</div>

<div id="invite-notification" style="display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:10000; width:90%; max-width:420px; background:white; padding:18px; border-radius:24px; box-shadow:0 25px 50px -12px rgba(0,0,0,0.25); border:1px solid #6366f1; animation: slideInTop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
    <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
        <div style="background:linear-gradient(135deg, #6366f1, #a855f7); width:50px; height:50px; border-radius:15px; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;">
            <i class="fas fa-paper-plane"></i>
        </div>
        <div style="flex:1;">
            <h4 style="margin:0; font-size:15px; color:#1e293b; font-weight:700;">Collaboration Request!</h4>
            <p id="invite-msg" style="margin:2px 0 0 0; font-size:13px; color:#64748b; line-height:1.4;"></p>
        </div>
    </div>
    <div style="display:flex; gap:10px;">
        <button id="accept-invite-btn" style="flex:2; background:#6366f1; color:white; border:none; padding:12px; border-radius:14px; font-weight:700; cursor:pointer; font-size:13px; transition: 0.2s;">Accept & Join</button>
        <button onclick="closeInvite()" style="flex:1; background:#f1f5f9; color:#475569; border:none; padding:12px; border-radius:14px; font-weight:600; cursor:pointer; font-size:13px;">Decline</button>
    </div>
</div>

<style>
@keyframes slideInTop {
    from { top: -150px; opacity: 0; }
    to { top: 20px; opacity: 1; }
}
#user-list::-webkit-scrollbar { width: 4px; }
#user-list::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
</style>



                <button id="collabToggleBtn" onclick="handleCollabMode()" style="background: #6366f1; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px; width: 100%; max-width: 220px;">
                    Enable Collab Writing
                </button>
         
            </div>
            
        </div>
    </div>


      <!-- <div id="share-area" style="display:none; margin-top:10px; padding:15px; background:#f8fafc; border:1px solid #cbd5e1; border-radius:12px;">
    <p style="margin:0 0 10px 0; font-size:13px; font-weight:bold; color:#1e293b;">Invite your partner to write together:</p>
    
    <div style="display:flex; flex-direction:column; gap:10px;">
        <div style="display:flex; gap:5px;">
            <input type="text" id="collabUrl" readonly style="flex:1; font-size:12px; padding:8px; border-radius:6px; border:1px solid #ddd; background:#fff;">
            <button onclick="copyCollabLink()" style="background:#6366f1; color:white; border:none; padding:5px 12px; border-radius:6px; cursor:pointer; font-size:12px;">
                <i class="fas fa-copy"></i> Copy
            </button>
        </div>

        <div style="display:flex; gap:10px; align-items:center; justify-content:center; margin-top:5px;">
            <button onclick="shareToWhatsApp()" style="background:#25D366; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; font-size:12px; display:flex; align-items:center; gap:5px;">
                <i class="fab fa-whatsapp"></i> WhatsApp
            </button>
            
            <button onclick="shareToEmail()" style="background:#ea4335; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; font-size:12px; display:flex; align-items:center; gap:5px;">
                <i class="fas fa-envelope"></i> Email
            </button>

            <button id="nativeShareBtn" onclick="shareNative()" style="background:#1e293b; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; font-size:12px; display:flex; align-items:center; gap:5px;">
                <i class="fas fa-share-alt"></i> Other
            </button>
        </div>
    </div>
</div> -->




    <div id="canvas-container" style="position: relative; max-width: 900px; margin: 0 auto;">
    <canvas id="studentShapeCanvas" style="position: absolute; top: 0; left: 0; z-index: 10; pointer-events: none; background: transparent;"></canvas>
    
    <div id="draw-timer" style="display:none; position:fixed; background:rgba(239, 68, 68, 0.9); color:white; padding:2px 8px; border-radius:4px; font-size:12px; pointer-events:none; z-index:10001; font-weight:bold;">0.0s</div>

    <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px 10px; background: #f1f5f9; border-radius: 8px 8px 0 0; border: 1px solid #e2e8f0; border-bottom: none;">
        <label style="color: #64748b; font-size: 0.75rem; font-weight: bold; text-transform: uppercase;">
            <i class="fas fa-robot"></i> AI Observation
        </label>
        <span id="ai-mood-suggestion" style="font-size: 0.8rem; font-weight: bold; transition: all 0.3s; color: #94a3b8;">
            Analyzing text...
        </span>
    </div>

    <div id="studentEditor" class="student-paper responsive-editor" contenteditable="true" style="position: relative; z-index: 1; min-height: 500px; border-top-left-radius: 0; border-top-right-radius: 0;">
        Student: Write or use Voice Note...
    </div>
</div>

    <button id="exitFocusBtn" onclick="toggleFocusMode()" style="display:none; position:fixed; bottom:20px; right:20px; z-index:9999; background:rgba(30,41,59,0.8); color:white; border:none; padding:15px; border-radius:50%; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.3);">
        <i class="fas fa-compress"></i>
    </button>
</div>


        <div id="saveModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(15, 23, 42, 0.9); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; padding:30px; border-radius:15px; width:90%; max-width:400px; color:#1e293b; box-shadow:0 20px 25px -5px rgba(0,0,0,0.2);">
        <h3 style="margin-top:0; color:#0f172a;">Complete Your Save</h3>
        
        <label style="display:block; margin-bottom:8px; font-weight:600; font-size:0.9rem;">Your Name</label>
        <!-- <input type="text" id="studentNameInput" placeholder="Enter full name" style="width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:8px; margin-bottom:20px; outline:none;"> -->
         <input type="text" id="studentNameInput" 
       oninput="localStorage.setItem('tempName', this.value)" 
       placeholder="Enter full name" ...>


        <div class="mood-selector" style="margin-bottom: 25px; text-align: center; background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0;">
            <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 12px; font-weight: 500;">How was the lesson today?</p>
            <div style="display: flex; justify-content: center; gap: 25px;">
                <label style="cursor:pointer; transition: transform 0.2s;"><input type="radio" name="mood" value="üòä" style="display:none;" checked> <span style="font-size:30px;">üòä</span></label>
                <label style="cursor:pointer; transition: transform 0.2s;"><input type="radio" name="mood" value="üòê" style="display:none;"> <span style="font-size:30px;">üòê</span></label>
                <label style="cursor:pointer; transition: transform 0.2s;"><input type="radio" name="mood" value="üòï" style="display:none;"> <span style="font-size:30px;">üòï</span></label>
            </div>
        </div>

        <div style="display:flex; gap:10px;">
            <button onclick="closeSaveModal()" style="flex:1; padding:12px; border-radius:8px; border:none; background:#e2e8f0; cursor:pointer;">Cancel</button>
            <button onclick="finalizeSave()" style="flex:2; padding:12px; border-radius:8px; border:none; background:#10b981; color:white; font-weight:600; cursor:pointer;">Save to Cloud</button>
        </div>
    </div>
</div>






<div id="section-admin" class="view-div hidden admin-view">
    <div class="admin-header no-print">
        <h1>Master Admin Panel</h1>
        
        <div style="display:flex; gap:10px; flex-wrap: wrap; align-items: center; width: 100%;">
            <input type="text" id="adminSearch" placeholder="üîç Search student name..." 
                   oninput="filterLogs(this.value)" 
                   style="padding:10px; border-radius:8px; border:1px solid var(--primary); background:#1e293b; color:white; flex-grow: 1; min-width:200px;">
            
            <button onclick="toggleSelectAll()" style="background:#475569; color:white; border:none; padding:10px 15px; border-radius:8px; cursor:pointer;">
                <i class="fas fa-check-double"></i> Select All
            </button>
            
            <button onclick="downloadFilteredHistory()" style="background:#10b981; color:white; border:none; padding:10px 15px; border-radius:8px; cursor:pointer;">
                <i class="fas fa-file-download"></i> Download Filtered
            </button>
            
            <button onclick="downloadSelectedRecords()" style="background:#6366f1; color:white; border:none; padding:10px 15px; border-radius:8px; cursor:pointer;">
                <i class="fas fa-tasks"></i> Download Selected
            </button>
            
            <button onclick="exportBackup()" style="background:orange; color:black; border:none; padding:10px; border-radius:8px; cursor:pointer;">Backup JSON</button>
            
            <p id="total-logs" style="align-self:center; font-weight: bold; margin-left: auto;">Logs: 0</p>
        </div>
    </div>

    <div class="stats-bar no-print" style="display: flex; gap: 15px; margin-bottom: 20px;">
        <div class="stat-box" style="flex:1; text-align:center; background:#dcfce7; color:#166534; border-radius:10px; padding:15px; border: 1px solid #bbf7d0;">
            <h4 style="margin:0;">Great Understanding</h4>
            <p id="stat-happy" style="font-size:1.5rem; font-weight:bold; margin:5px 0;">0</p>
        </div>
        <div class="stat-box" style="flex:1; text-align:center; background:#fef9c3; color:#854d0e; border-radius:10px; padding:15px; border: 1px solid #fef08a;">
            <h4 style="margin:0;">Needs Review</h4>
            <p id="stat-neutral" style="font-size:1.5rem; font-weight:bold; margin:5px 0;">0</p>
        </div>
        <div class="stat-box" style="flex:1; text-align:center; background:#fecaca; color:#991b1b; border-radius:10px; padding:15px; border: 1px solid #fca5a5;">
            <h4 style="margin:0;">Confused</h4>
            <p id="stat-confused" style="font-size:1.5rem; font-weight:bold; margin:5px 0;">0</p>
        </div>
        <div id="admin-video-upload" style="background: #1e293b; padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white;">
    <h3><i class="fas fa-video"></i> Upload Lesson Video</h3>
    <input type="file" id="videoFile" accept="video/*" style="margin-bottom: 10px;">
    
    <div id="upload-progress-container" style="display:none; width: 100%; background: #334155; border-radius: 10px; height: 10px; margin: 10px 0;">
        <div id="upload-progress-bar" style="width: 0%; background: #10b981; height: 100%; border-radius: 10px; transition: width 0.3s;"></div>
    </div>
    
    <button onclick="uploadVideo()" id="uploadBtn" style="background: #6366f1; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;">
        Start Upload
    </button>
</div>
    </div>

    <div class="no-print" style="display:flex; gap:10px; margin-bottom:20px; flex-wrap: wrap; align-items: center;">
        <button onclick="displayLogs(allCloudLogs)" style="background:#475569; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">
            <i class="fas fa-list"></i> Show All
        </button>
        <button onclick="filterByMood('üòï')" style="background:#ef4444; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">
            <i class="fas fa-exclamation-circle"></i> Show Confused Only
        </button>
        
        <button onclick="resetDailyDashboard()" style="background:#dc2626; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; margin-left:auto;">
            <i class="fas fa-trash-alt"></i> Reset Daily Dashboard
        </button>
    </div>

    <div id="priority-alerts" style="margin-bottom: 20px;"></div>

    <div id="admin-content-list" style="min-height: 200px;">
        </div>
</div>

    <div id="image-adjuster" class="image-controls-panel no-print">
        <h4 style="margin-bottom:15px; color:var(--primary);">Adjust Image Position</h4>
        <div class="grid-ctrl">
            <div></div><button onclick="moveImage('up')"><i class="fas fa-arrow-up"></i></button><div></div>
            <button onclick="moveImage('left')"><i class="fas fa-arrow-left"></i></button>
            <button onclick="activeImg=null; document.getElementById('image-adjuster').style.display='none';" style="background:green;"><i class="fas fa-check"></i></button>
            <button onclick="moveImage('right')"><i class="fas fa-arrow-right"></i></button>
            <div></div><button onclick="moveImage('down')"><i class="fas fa-arrow-down"></i></button><div></div>
        </div>
        <p style="margin-top:15px; font-size:12px;">Resize Image:</p>
        <input type="range" min="50" max="1500" style="width:100%;" oninput="resizeImage(this.value)">
    </div>

<script>
    
    const firebaseConfig = {
        apiKey: "AIzaSyD4NZ7BhlCVmRRiRqdXRs5TluNBgCtxBOU",
        authDomain: "eduflow-storage.firebaseapp.com",
        databaseURL: "https://eduflow-storage-default-rtdb.firebaseio.com",
        projectId: "eduflow-storage",
        storageBucket: "eduflow-storage.firebasestorage.app",
        messagingSenderId: "1031861595930",
        appId: "1:1031861595930:web:a516008c231e31bb0b06a3"
    };
 firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let allCloudLogs = []; 

// Define the tools


// --- ADD THE TIME TRACKING CODE HERE ---
let activeSeconds = 0;
let typingTimer;
let clockInterval;

function trackActiveTime() {
    if (!clockInterval) {
        clockInterval = setInterval(() => {
            activeSeconds++;
            updateTimerUI();
        }, 1000);
    }
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => {
        clearInterval(clockInterval);
        clockInterval = null;
    }, 3000); 
}

function formatTime(s) {
    const mins = Math.floor(s / 60);
    const secs = s % 60;
    return `${mins}m ${secs}s`;
}

function updateTimerUI() {
    const display = document.getElementById('active-timer-display');
    if(display) display.innerText = `Active Work: ${formatTime(activeSeconds)}`;
}


// Or place it inside your 'window.onload' function
document.addEventListener('DOMContentLoaded', () => {
    const editor = document.getElementById('studentEditor');
    if(editor) {
        editor.addEventListener('input', trackActiveTime);
    }
});


    // --- YOUR EXISTING VARIABLES ---
    const canvas = document.getElementById('teachingBoard');
    const ctx = canvas.getContext('2d');
    const teacherWrap = document.getElementById('teacher-wrap');
    const studentArea = document.getElementById('studentEditor');
    const teacherArea = document.getElementById('teacherEditor');
    let drawing = false, activeImg = null, currentMode = 'text';
    let startX, startY;
    let isSaved = false;

    studentArea.addEventListener('input', () => { isSaved = false; }); 

    window.onload = () => {
        resizeCanvas();
        ctx.lineCap = 'round';
        ctx.lineWidth = 3;
        renderAdminLogs(); // Updated to fetch from cloud
    };

    window.onresize = resizeCanvas;

    function resizeCanvas() {
        canvas.width = window.innerWidth - (window.innerWidth > 768 ? 75 : 0);
        canvas.height = 3000;
    }

    // --- PRESERVED DRAWING LOGIC ---
    function setMode(m) {
        currentMode = m;
        showToast("Mode: " + m);
        teacherArea.style.pointerEvents = (m === 'pen' || m === 'rect') ? 'none' : 'auto';
        
    }

    function getActiveColor() {
        return window.innerWidth <= 768 ? document.getElementById('teachColorMob').value : document.getElementById('teachColor').value;
    }

    function getCoords(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function startDraw(e) {
        if (currentMode === 'text') return;
        drawing = true;
        const coords = getCoords(e);
        startX = coords.x; startY = coords.y;
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.strokeStyle = getActiveColor();
    }

    function doDraw(e) {
        if (!drawing || currentMode === 'text') return;
        const coords = getCoords(e);
        if(currentMode === 'pen') {
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();
        }
    }

    function stopDraw(e) {
        if (!drawing) return;
        if(currentMode === 'rect') {
            const coords = getCoords(e.changedTouches ? e.changedTouches[0] : e);
            ctx.strokeStyle = getActiveColor();
            ctx.strokeRect(startX, startY, coords.x - startX, coords.y - startY);
        }
        drawing = false;
        ctx.closePath();
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', doDraw);
    window.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDraw(e); }, {passive: false});
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); doDraw(e); }, {passive: false});
    canvas.addEventListener('touchend', (e) => { stopDraw(e); });

    // --- PRESERVED TEXT & UTILITY LOGIC ---
    function styleSelectedText(command, value) {
        teacherArea.focus();
        document.execCommand(command, false, value);
    }

    function changeFontSize(dir) {
        teacherArea.focus();
        let currentSize = window.getComputedStyle(teacherArea).fontSize;
        let newSize = parseInt(currentSize) + (dir * 2);
        document.execCommand('fontSize', false, "7");
        const spans = teacherArea.getElementsByTagName("font");
        for (let i = 0; i < spans.length; i++) {
            if(spans[i].size == "7") {
                spans[i].removeAttribute("size");
                spans[i].style.fontSize = newSize + "px";
            }
        }
        if (!window.getSelection().toString()) teacherArea.style.fontSize = newSize + "px";
    }

    function addTeacherText(type) {
        setMode('text');
        const span = document.createElement("span");
        span.style.color = (type === 'Q' ? 'red' : 'white');
        span.style.fontWeight = 'bold';
        span.innerText = `\n${type === 'Q' ? 'Question: ' : 'Answer: '}`;
        teacherArea.focus();
        const sel = window.getSelection();
        if(sel.rangeCount > 0) {
            const range = sel.getRangeAt(0);
            range.insertNode(span);
            range.collapse(false);
        }
    }

    function startVoiceRecognition(targetId) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) return alert("Speech not supported.");
        const recognition = new SpeechRecognition();
        const btn = document.getElementById('voiceStartBtn');
        const editor = document.getElementById(targetId);
        recognition.onstart = () => { btn.classList.add('voice-btn'); showToast("Listening..."); };
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            editor.focus();
            document.execCommand('insertText', false, " " + transcript);
            isSaved = false; 
        };
        recognition.onend = () => btn.classList.remove('voice-btn');
        recognition.onerror = () => btn.classList.remove('voice-btn');
        recognition.start();
    }

    // --- PRESERVED IMAGE LOGIC ---
    function handleImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = document.createElement('img');
                img.src = event.target.result;
                img.className = 'img-adjustable';
                img.style.width = '300px';
                img.style.left = '50px';
                img.style.top = (window.scrollY + 150) + 'px';
                img.onclick = function(ev) {
                    ev.stopPropagation();
                    activeImg = this;
                    document.getElementById('image-adjuster').style.display = 'block';
                };
                teacherWrap.appendChild(img);
                isSaved = false;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function setupImageUpload(inputId, container) {
        document.getElementById(inputId).onchange = function(e) { handleImage(this); };
    }
    setupImageUpload('teachImg', teacherWrap);
    setupImageUpload('studentImgInp', studentArea);

    function moveImage(dir) {
        if(!activeImg) return;
        let step = 30;
        let top = parseInt(activeImg.style.top) || 0;
        let left = parseInt(activeImg.style.left) || 0;
        if(dir === 'up') activeImg.style.top = (top - step) + 'px';
        if(dir === 'down') activeImg.style.top = (top + step) + 'px';
        if(dir === 'left') activeImg.style.left = (left - step) + 'px';
        if(dir === 'right') activeImg.style.left = (left + step) + 'px';
    }
    function resizeImage(v) { if(activeImg) activeImg.style.width = v + 'px'; }

    // --- UPDATED: CLOUD SAVE & ADMIN LOGIC ---
    function nav(mode) {
        document.querySelectorAll('.view-div').forEach(v => v.classList.add('hidden'));
        document.getElementById('section-' + mode).classList.remove('hidden');
        document.querySelectorAll('.sidebar i').forEach(i => i.classList.remove('active'));
        document.getElementById('nav-' + mode).classList.add('active');
    }

    function openAdmin() {
    let pass = prompt("Admin Password:");
    if(pass === "admin") { 
        nav('admin'); // Navigate first
        renderAdminLogs(); // Then fetch/render
    } else {
        alert("Wrong Password");
    }
}

    // PART 1: Just opens the modal
function saveSession() {
    const modal = document.getElementById('saveModal');
    if (modal) {
        modal.style.display = 'flex';
    } else {
        alert("Modal Error: Make sure the saveModal HTML is present.");
    }
}








// Helper to close modal
function closeSaveModal() {
    document.getElementById('saveModal').style.display = 'none';
}


async function finalizeSave() {
    const studentName = document.getElementById('studentNameInput').value.trim();
    const studentContent = document.getElementById('studentEditor').innerHTML;
    
    // 1. CAPTURE THE CANVAS DATA
    const canvas = document.getElementById('studentShapeCanvas');
    const shapeData = canvas ? canvas.toDataURL("image/png") : null;

    // Get the selected mood
    const moodElement = document.querySelector('input[name="mood"]:checked');
    const studentMood = moodElement ? moodElement.value : "üòä";

    if (!studentName) {
        alert("Please enter a name before saving!");
        return;
    }

    showToast("Saving unique record...");
    
    try {
        const timestamp = Date.now();
        const dateString = new Date().toLocaleString();
        const finalActiveTime = formatTime(activeSeconds);

        await db.collection("edu_logs").add({
            studentName: studentName,
            data: studentContent,
            shapes: shapeData, // 2. SAVE THE SHAPES TO FIREBASE
            mood: studentMood,
            timestamp: timestamp,
            dateString: dateString,
            totalActiveTime: finalActiveTime,
            isVersion: true 
        });

        isSaved = true; 
        showToast("‚úÖ Saved as a new record!");
        document.getElementById('saveBtn').style.background = "#059669";
        
        // 3. CLEAR THE CANVAS FOR THE NEXT RECORD
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        activeSeconds = 0; 
        updateTimerUI(); 
        closeSaveModal();
        document.getElementById('studentNameInput').value = ""; 
        
    } catch (e) {
        console.error("Save Error:", e);
        showToast("‚ùå Save Failed!");
    }
}
    function renderAdminLogs() {
  
    db.collection("edu_logs").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
        allCloudLogs = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        
        const term = document.getElementById('adminSearch').value;
        if(term) {
            filterLogs(term);
        } else {
            displayLogs(allCloudLogs);
        }
    }, (error) => {
        console.error("Error fetching logs: ", error);
        showToast("Error loading logs");
    });
}


function displayLogs(logs, highlightTerm = "") {
    // 1. Update Stats Bar
    const happyCount = logs.filter(l => l.mood === 'üòä').length;
    const neutralCount = logs.filter(l => l.mood === 'üòê').length;
    const confusedCount = logs.filter(l => l.mood === 'üòï').length;

    if(document.getElementById('stat-happy')) document.getElementById('stat-happy').innerText = happyCount;
    if(document.getElementById('stat-neutral')) document.getElementById('stat-neutral').innerText = neutralCount;
    if(document.getElementById('stat-confused')) document.getElementById('stat-confused').innerText = confusedCount;

    const list = document.getElementById('admin-content-list');
    const totalCount = document.getElementById('total-logs');
    if(totalCount) totalCount.innerText = `Logs: ${logs.length}`;

    // 2. Handle Empty State
    if (logs.length === 0) {
        list.innerHTML = "<p style='text-align:center; padding:20px;'>No records found.</p>";
        return;
    }

    // 3. Handle Priority Alerts (Responsive Flex)
    const priorityStudents = logs.filter(item => item.mood === 'üòï');
    const priorityDiv = document.getElementById('priority-alerts');
    
    if (priorityDiv) {
        if (priorityStudents.length > 0) {
            priorityDiv.innerHTML = `
                <div style="background:#fef2f2; border:2px solid #ef4444; padding:15px; border-radius:12px; margin-bottom:20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                    <h4 style="color:#991b1b; margin:0 0 10px 0; display:flex; align-items:center; gap:8px; font-size:clamp(14px, 4vw, 18px);">
                        <i class="fas fa-exclamation-triangle"></i> Needs Immediate Help
                    </h4>
                    <div style="display:flex; flex-wrap:wrap; gap:8px;">
                        ${priorityStudents.map(s => `<span style="background:#ef4444; color:white; padding:6px 12px; border-radius:20px; font-size:12px; font-weight:bold;">${s.studentName}</span>`).join('')}
                    </div>
                </div>`;
        } else {
            priorityDiv.innerHTML = "";
        }
    }

    // 4. Render Main List
    list.innerHTML = logs.map((item, index) => {
        let content = item.data;
        
        // Subject Tag Detection (Kept all your tags)
        const textForTag = (item.data || "").toLowerCase();
        let tag = "";
        if (textForTag.includes("#math") || textForTag.includes("fraction") || textForTag.includes("=")) tag = "Math";
        else if (textForTag.includes("#science") || textForTag.includes("atom") || textForTag.includes("energy")) tag = "Science";
        else if (textForTag.includes("#english") || textForTag.includes("verb") || textForTag.includes("poem")) tag = "English";
        else if (textForTag.includes("#java")) tag = "Java";
        else if (textForTag.includes("#python")) tag = "Python";
        else if (textForTag.includes("#oracle")) tag = "Oracle";
        else if (textForTag.includes("#ai")) tag = "AI";

        const tagUI = tag ? `<span style="background:#e0e7ff; color:#4338ca; padding:2px 8px; border-radius:4px; font-size:10px; font-weight:bold; margin-left:10px; text-transform:uppercase;">${tag}</span>` : "";

        // Keyword Highlight
        if (highlightTerm && highlightTerm.length > 2) {
            const regex = new RegExp(`(${highlightTerm})`, 'gi');
            content = content.replace(regex, `<mark style="background:yellow; color:black; font-weight:bold;">$1</mark>`);
        }

        // Version History UI
        const hasHistory = item.versions && item.versions.length > 1;
        const versionUI = hasHistory ? `
            <div style="margin: 10px 0; background: #f1f5f9; padding: 8px 12px; border-radius: 6px; display: flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <span style="font-size: 11px; color: #64748b; font-weight: bold; text-transform: uppercase;">History:</span>
                <input type="range" min="0" max="${item.versions.length - 1}" value="${item.versions.length - 1}" 
                       oninput="updateCardContent('${index}', this.value)" 
                       style="flex-grow: 1; cursor: pointer; min-width:100px;">
                <span id="version-label-${index}" style="font-size: 11px; color: #6366f1;">Latest</span>
            </div>` : '';

        return `
        <div class="data-card admin-log-item" id="log-card-${index}" 
             style="border-left: 5px solid ${item.mood === 'üòï' ? '#ef4444' : '#6366f1'}; background:white; margin-bottom:20px; border-radius:12px; padding:15px; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
            
            <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px; border-bottom: 1px solid #e2e8f0; padding-bottom:10px; margin-bottom:10px;">
                <div style="display:flex; flex-direction:column; gap:4px;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" class="log-checkbox" data-index="${index}" style="width:18px; height:18px;">
                        <strong style="font-size: clamp(14px, 4vw, 16px); color: #10b981 !important;">
                            <i class="fas fa-user"></i> ${item.studentName || 'Unknown'} 
                            <span style="font-size: 1.2rem; margin-left: 5px;">${item.mood || ''}</span>
                            ${tagUI} 
                        </strong>
                    </div>
                    <span style="font-size:11px; color:#94a3b8; margin-left:28px;">${item.dateString || ''}</span>
                </div>

                <div style="display:flex; flex-direction:column; align-items:flex-end; gap:8px;">
                    <p style="font-size:11px; color:#64748b; margin:0;">
                        <i class="fas fa-keyboard"></i> Effort: <b>${item.totalActiveTime || '0s'}</b>
                    </p>
                    <div style="display:flex; gap:4px;">
                        <button onclick="shareRecordQR('${index}')" class="admin-btn" title="QR Share" style="background:#8b5cf6;"><i class="fas fa-share-nodes"></i></button>
                        <button onclick="sendEmail('${index}')" class="admin-btn" title="Email" style="background:#10b981;"><i class="fas fa-envelope"></i></button>
                        <button onclick="copyToClipboard('${index}')" class="admin-btn" title="Copy" style="background:#475569;"><i class="fas fa-copy"></i></button>
                        <button onclick="downloadSingleRecord('${index}', '${item.studentName}')" class="admin-btn" title="PDF" style="background:#6366f1;"><i class="fas fa-file-pdf"></i></button>
                    </div>
                </div>
            </div>

            ${versionUI}

            <div class="responsive-paper-wrapper" 
                 onclick="this.classList.toggle('zoomed')"
                 style="width: 100%; overflow: hidden; border: 1px solid #e2e8f0; border-radius: 8px; background: white; cursor:zoom-in; transition: 0.3s;">
                
                <div id="content-body-${index}" class="scaler-engine" 
                     style="width: 900px; transform-origin: top left; position: relative;">
                    
                    <div id="text-layer-${index}" style="padding: 20px; font-size: 16px; line-height: 1.6; color: black; width: 900px; box-sizing: border-box; word-wrap: break-word; min-height: 50px;">
                        ${content}
                    </div>

                    <div id="shape-layer-${index}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                        ${item.shapes ? `<img src="${item.shapes}" style="width: 100%; height: 100%; object-fit: fill;">` : ''}
                    </div>
                </div>
            </div>
        </div>`;
    }).join('');

    // Trigger calculation
    handleResponsiveScaling();
}


    function filterLogs(term) {
    const filtered = allCloudLogs.filter(log => 
        log.studentName?.toLowerCase().includes(term.toLowerCase()) ||
        log.data?.toLowerCase().includes(term.toLowerCase())
    );
    displayLogs(filtered, term); // Pass the search term to displayLogs
}


    async function downloadFilteredHistory() {
        const listArea = document.getElementById('admin-content-list');
        if (listArea.children.length === 0) {
            alert("Nothing to download!");
            return;
        }

        const fileName = prompt("Enter filename for history:", "Student_History_Export");
        if(!fileName) return;

        showToast("Generating History PDF...");
        
        // Temporarily change background for better PDF readability
        const originalBg = listArea.style.background;
        listArea.style.background = "#f3f4f6"; 

        html2canvas(listArea, {
            useCORS: true,
            scale: 2,
            backgroundColor: "#f3f4f6"
        }).then(canvasShot => {
            listArea.style.background = originalBg;
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgData = canvasShot.toDataURL('image/png');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const imgProps = pdf.getImageProperties(imgData);
            const pdfImgHeight = (imgProps.height * pageWidth) / imgProps.width;
            
            let heightLeft = pdfImgHeight;
            let position = 0;

            pdf.addImage(imgData, 'PNG', 0, position, pageWidth, pdfImgHeight);
            heightLeft -= pageHeight;

            while (heightLeft >= 0) {
                position = heightLeft - pdfImgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, pageWidth, pdfImgHeight);
                heightLeft -= pageHeight;
            }

            pdf.save(fileName + ".pdf");
            showToast("History Downloaded!");
        });
    }

    async function downloadSingleRecord(index, studentName) {
    const card = document.getElementById(`log-card-${index}`);
    const downloadBtn = card.querySelector('button');
    
    // Hide the download button momentarily so it doesn't appear in the PDF
    downloadBtn.style.display = 'none';
    
    showToast(`Preparing PDF for ${studentName}...`);

    html2canvas(card, {
        useCORS: true,
        scale: 2,
        backgroundColor: "#ffffff"
    }).then(canvasShot => {
        downloadBtn.style.display = 'block'; // Show button again
        
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgData = canvasShot.toDataURL('image/png');
        
        const pageWidth = pdf.internal.pageSize.getWidth();
        const imgProps = pdf.getImageProperties(imgData);
        const pdfImgHeight = (imgProps.height * pageWidth) / imgProps.width;

        pdf.addImage(imgData, 'PNG', 0, 5, pageWidth, pdfImgHeight);
        pdf.save(`${studentName}_Record.pdf`);
        
        showToast("Single Record Downloaded!");
    });
}



async function downloadSelectedRecords() {
    const checkboxes = document.querySelectorAll('.log-checkbox:checked');
    if (checkboxes.length === 0) {
        alert("Please select at least one record.");
        return;
    }

    const fileName = prompt("Enter filename:", "EduFlow_Export");
    if(!fileName) return;

    showToast(`Generating PDF...`);

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    
    // We increase the top margin to 20mm to leave room for the page number
    const topMargin = 20; 
    const sideMargin = 10;
    const bottomMargin = 15;
    const contentWidth = pageWidth - (sideMargin * 2);
    let currentY = topMargin;

    for (let i = 0; i < checkboxes.length; i++) {
        const index = checkboxes[i].getAttribute('data-index');
        const card = document.getElementById(`log-card-${index}`);
        
        const cb = card.querySelector('.log-checkbox');
        const btn = card.querySelector('button');
        cb.style.opacity = '0';
        btn.style.opacity = '0';

        const canvasShot = await html2canvas(card, { 
            useCORS: true, 
            scale: 2, 
            backgroundColor: "#ffffff",
            height: card.scrollHeight 
        });
        
        cb.style.opacity = '1';
        btn.style.opacity = '1';

        const imgProps = pdf.getImageProperties(canvasShot.toDataURL('image/png'));
        const totalImgHeightInPdf = (imgProps.height * contentWidth) / imgProps.width;

        let remainingHeight = totalImgHeightInPdf;
        let sourceYmm = 0; 

        while (remainingHeight > 0) {
            // Space available calculation now respects the top and bottom margins
            const spaceAvailable = pageHeight - currentY - bottomMargin;
            const hToDraw = Math.min(remainingHeight, spaceAvailable);

            const sliceCanvas = document.createElement('canvas');
            sliceCanvas.width = canvasShot.width;
            sliceCanvas.height = (hToDraw * canvasShot.width) / contentWidth;
            const sliceCtx = sliceCanvas.getContext('2d');

            sliceCtx.drawImage(
                canvasShot, 
                0, (sourceYmm * canvasShot.width) / contentWidth, 
                canvasShot.width, (hToDraw * canvasShot.width) / contentWidth, 
                0, 0, 
                sliceCanvas.width, sliceCanvas.height
            );

            const slicedImgData = sliceCanvas.toDataURL('image/png');
            pdf.addImage(slicedImgData, 'PNG', sideMargin, currentY, contentWidth, hToDraw);

            remainingHeight -= hToDraw;
            sourceYmm += hToDraw;

            if (remainingHeight > 0) {
                pdf.addPage();
                currentY = topMargin; // Reset to the top margin on new page
            } else {
                currentY += hToDraw + 10; 
            }
        }
    }

    // --- ADD PAGE NUMBERS IN TOP RIGHT CORNER ---
    const totalPages = pdf.internal.getNumberOfPages();
    for (let j = 1; j <= totalPages; j++) {
        pdf.setPage(j);
        pdf.setFontSize(10);
        pdf.setTextColor(100); // Subtle grey color
        
        const pageText = `Page ${j} of ${totalPages}`;
        // x = pageWidth - 15 (15mm from right edge), y = 12 (12mm from top edge)
        pdf.text(pageText, pageWidth - 15, 12, { align: 'right' });
        
        // Optional: Add a subtle thin line under the page number
        pdf.setDrawColor(200);
        pdf.line(sideMargin, 15, pageWidth - sideMargin, 15);
    }

    pdf.save(fileName + ".pdf");
    showToast("‚úÖ PDF with Top Corner Numbers Downloaded!");
}
    function addStyledText(type) {
        const span = document.createElement("span");
        span.className = (type === 'Q' ? 'q-text' : 'a-text');
        span.style.color = (type === 'Q' ? 'red' : 'black');
        span.innerText = `\n${type === 'Q' ? 'Question: ' : 'Answer: '}`;
        studentArea.focus();
        window.getSelection().getRangeAt(0).insertNode(span);
        isSaved = false;
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.right = "20px";
        setTimeout(() => t.style.right = "-300px", 3000);
    }

    function clearCanvas() { 
        ctx.clearRect(0,0,canvas.width, canvas.height); 
        teacherArea.innerHTML = "Teacher: Click to type, or use Pen..."; 
    }

    let allSelected = false;
function toggleSelectAll() {
    allSelected = !allSelected;
    const checkboxes = document.querySelectorAll('.log-checkbox');
    checkboxes.forEach(cb => cb.checked = allSelected);
    showToast(allSelected ? "All selected" : "Selection cleared");
}


function generateRecordQR(docId) {
    const currentUrl = window.location.origin + window.location.pathname;
    // Ensure this matches your URL structure
const shareUrl = `${window.location.origin}${window.location.pathname}?portfolio=${docId}`;
    
    // Change 'qr-result' to 'qrcode' to match your HTML
    const qrContainer = document.getElementById('qrcode'); 
    qrContainer.innerHTML = ""; 
    
    new QRCode(qrContainer, {
        text: shareUrl,
        width: 180,
        height: 180
    });
    
    // Show the modal
    document.getElementById('qrModal').style.display = 'flex';
}


function copyToClipboard(index) {
    // We get the data from our original logs array
    // This ensures we copy the CLEAN text, not the version with <mark> tags
    const logEntry = allCloudLogs[index]; 
    if (!logEntry) return;

    // Remove any HTML tags just in case
    const cleanText = logEntry.data.replace(/<\/?[^>]+(>|$)/g, "");

    navigator.clipboard.writeText(cleanText).then(() => {
        showToast("üìã Copied to clipboard!");
    }).catch(() => {
        showToast("‚ùå Failed to copy");
    });
}

function sendEmail(index) {
    const logEntry = allCloudLogs[index];
    if (!logEntry) return;

    // Clean the text of any HTML tags
    const cleanBody = logEntry.data.replace(/<\/?[^>]+(>|$)/g, "");
    const subject = encodeURIComponent(`Education Record: ${logEntry.studentName}`);
    
    // Construct the mailto link
    const mailtoLink = `mailto:?subject=${subject}&body=${encodeURIComponent(cleanBody)}`;

    // Open the user's default email app
    window.location.href = mailtoLink;
    showToast("Opening Email Client...");
}




function shareRecordQR(index) {
    console.log("Attempting to share index:", index);
    
    // Check if the logs exist
    if (!allCloudLogs || !allCloudLogs[index]) {
        console.error("Log entry not found at index", index);
        alert("Error: Record data missing.");
        return;
    }

    const logEntry = allCloudLogs[index];
    const recordId = logEntry.id; 

    if (!recordId) {
        console.error("This record is missing a Firebase Document ID!");
        alert("Cannot share: Record has no ID.");
        return;
    }

    // Ask for expiry
    const hours = prompt("Link expires in how many hours?", "24");
    if (hours === null) return; // User cancelled

    const expiryTime = Date.now() + (parseFloat(hours) * 60 * 60 * 1000);
    // Change this line in shareRecordQR:
    // Change this line to use 'view' so it matches the logic above
const shareUrl = `${window.location.origin}${window.location.pathname}?view=${logEntry.id}`;
    // const shareUrl = `${window.location.origin}${window.location.pathname}?portfolio=${encodeURIComponent(logEntry.studentName)}`;
    // const shareUrl = `${window.location.origin}${window.location.pathname}?view=${recordId}&exp=${expiryTime}`;

    console.log("Generated Share URL:", shareUrl);

    // Show the Modal
    const qrModal = document.getElementById('qrModal');
    const qrContainer = document.getElementById("qrcode");
    
    if (!qrModal || !qrContainer) {
        alert("HTML Error: qrModal or qrcode div is missing from your page!");
        return;
    }

    qrContainer.innerHTML = `<p style="color:black; margin-bottom:10px;"><b>Scan to view ${logEntry.studentName}'s record</b></p>`;
    qrModal.style.display = 'flex';

    // Generate the QR
    try {
        new QRCode(qrContainer, {
            text: shareUrl,
            width: 200,
            height: 200
        });
    } catch (e) {
        console.error("QR Library Error:", e);
        alert("QR Library (qrcode.js) is not loaded!");
    }
}


window.onload = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const portfolioName = urlParams.get('portfolio');
    const viewId = urlParams.get('view');
    const roomId = urlParams.get('room'); 
    if (portfolioName) {
        setupGuestViewContainer(); 
        if (typeof loadStudentPortfolio === "function") loadStudentPortfolio(portfolioName);
        return; 
    } 
    if (viewId) {
        setupGuestViewContainer(); 
        if (typeof loadSingleSharedRecord === "function") loadSingleSharedRecord(viewId);
        return;
    }
    if (roomId) {
        console.log("Found Room ID:", roomId);
        const btn = document.getElementById('collabToggleBtn');
        const status = document.getElementById('partner-status');
        
        if (btn) {
            // This turns the button into a "JOIN" button for Student B
            btn.innerText = "Connect to Partner"; 
            btn.style.background = "#6366f1"; // Blue color
            btn.style.boxShadow = "0 0 15px rgba(99, 102, 241, 0.5)";
        }
        if (status) {
            status.innerText = "Partner waiting...";
            status.style.color = "#6366f1";
        }
    }

    // --- 3. NORMAL APP MODE ---
    const savedName = localStorage.getItem('tempName');
    const nameInput = document.getElementById('studentNameInput');
    if (savedName && nameInput) {
        nameInput.value = savedName;
        if (typeof initAutoSaveListener === "function") initAutoSaveListener();
    }
    if (roomId) {
        setTimeout(() => {
            handleCollabMode(); 
        }, 500); 
    }
};


function setupGuestViewContainer() {
    document.body.innerHTML = `
        <div style="background: #0f172a; min-height: 100vh; padding: 40px 20px; font-family: sans-serif;">
            <div id="single-view-container" style="max-width: 800px; margin: 0 auto; color: white;">
                <p>Loading records for you...</p>
            </div>
        </div>`;
}


function initAutoSaveListener() {
    const editor = document.getElementById('studentEditor');
    const moodDisplay = document.getElementById('ai-mood-suggestion'); 

    if (!editor) return;

    editor.addEventListener('input', () => {
        const text = editor.innerText || editor.value;
        const suggestion = analyzeSentiment(text);
        if (text.length > 5) {
            moodDisplay.innerHTML = `AI Suggestion: ${suggestion.emoji}`;
            moodDisplay.style.color = suggestion.color;
            const radioToSelect = document.querySelector(`input[value="${suggestion.emoji}"]`);
            if (radioToSelect) radioToSelect.checked = true;
        }
    });
}







async function loadSingleSharedRecord(id) {
    const container = document.getElementById('single-view-container');
    if (!container || !id) return;

    try {
        const doc = await db.collection("edu_logs").doc(id).get();

        if (doc.exists) {
            const data = doc.data();
            
            container.innerHTML = `
                <div style="background:white; color:#1e293b; padding:40px; border-radius:15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative;">
                    
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px;">
                        <div>
                            <h1 style="margin:0; color:#0f172a; font-size:1.8rem;">${data.studentName}'s Record</h1>
                            <small style="color:#64748b;">Recorded on: ${data.dateString || 'N/A'}</small>
                        </div>
                        <div style="font-size:1.5rem;">${data.mood || 'üòä'}</div>
                    </div>

                    <hr style="border:0; border-top:1px solid #f1f5f9; margin:20px 0;">

                    <div id="content-canvas-wrapper" style="position: relative; min-height: 400px; line-height: 1.6;">
                        
                        <div style="position: relative; z-index: 1; font-size: 1.1rem;">
                            ${data.data}
                        </div>

                        ${data.shapes ? `
                            <img src="${data.shapes}" 
                                 style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; object-fit: contain;">
                        ` : ''}
                    </div>

                    <div style="margin-top:30px; padding-top:20px; border-top:1px dashed #e2e8f0; color:#94a3b8; font-size:0.8rem; display:flex; justify-content:space-between;">
                        <span>Reference: ${id}</span>
                        <span>Time Spent: ${data.totalActiveTime || 'N/A'}</span>
                    </div>
                </div>

                <p style="text-align:center; margin-top:20px;">
                    <a href="${window.location.origin}${window.location.pathname}" style="color:#94a3b8; text-decoration:none; font-weight:bold;">
                        <i class="fas fa-arrow-left"></i> Return to Platform
                    </a>
                </p>
            `;
            
            // Fade in effect
            container.style.opacity = "0";
            setTimeout(() => { container.style.transition = "opacity 0.5s"; container.style.opacity = "1"; }, 100);

        } else {
            container.innerHTML = `
                <div style="text-align:center; color:white; padding:50px;">
                    <i class="fas fa-exclamation-triangle fa-3x" style="color:#f59e0b;"></i>
                    <h2>Record Not Found</h2>
                    <p>This link may have expired or the record was deleted.</p>
                </div>`;
        }
    } catch (error) {
        console.error("Firebase Error:", error);
        container.innerHTML = "<h2 style='color:white; text-align:center;'>Connection Error. Please check your internet.</h2>";
    }
}

// FEATURE: Filter by Mood
function filterByMood(moodEmoji) {
    const filtered = allCloudLogs.filter(log => log.mood === moodEmoji);
    displayLogs(filtered);
    showToast(`Showing ${filtered.length} students with ${moodEmoji}`);
}

// FEATURE: Reset Dashboard (Delete all current logs)
async function resetDailyDashboard() {
    const confirmation = confirm("Are you sure? This will delete ALL records from the database for the new day. This cannot be undone.");
    
    if (confirmation) {
        showToast("Cleaning database...");
        try {
            const snapshot = await db.collection("edu_logs").get();
            const batch = db.batch();
            
            snapshot.docs.forEach((doc) => {
                batch.delete(doc.ref);
            });
            
            await batch.commit();
            showToast("‚úÖ Dashboard Reset Successfully!");
        } catch (error) {
            console.error("Error resetting:", error);
            showToast("‚ùå Reset Failed!");
        }
    }
}



async function handleCollabMode() {
    console.log("Starting Collab Mode...");
    
    // Check if we are JOINING an existing room
    const urlParams = new URLSearchParams(window.location.search);
    let roomId = urlParams.get('room');

    // GET SUBJECT: Only force it if we are STARTING a new room
    let subject = document.getElementById('subjectInput')?.value;
    if (!roomId && !subject) {
        alert("Please enter a subject name to start a new session!");
        return;
    }
    
    // If joining a link, default the subject if input is empty
    if (roomId && !subject) subject = "Joined Session";

    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();

    try {
        let user = auth.currentUser;
        if (!user) {
            try {
                // Try popup login
                const result = await auth.signInWithPopup(provider);
                user = result.user;
            } catch (authError) {
                console.warn("Using Guest Identity.");
                user = { 
                    uid: "guest-" + Math.random().toString(36).substring(2, 7),
                    displayName: "Guest Student" 
                };
            }
        }

        currentUser = user; 
        
        // --- ACTIVATING SYSTEMS ---
        // This makes the student visible in the "Online" list
        if (typeof startPresence === "function") startPresence(user, subject); 
        
        // This ensures they can RECEIVE the professional slide-down card
        if (typeof listenForInvites === "function") listenForInvites(user); 

        // --- ROOM LOGIC ---
        if (!roomId) {
            // No room in URL? We are the Host. Create one.
            roomId = "collab-" + Math.random().toString(36).substring(2, 8);
            const newUrl = window.location.origin + window.location.pathname + "?room=" + roomId;
            window.history.pushState({}, '', newUrl);
        } 
        
        // Show the Share Area
        const collabInput = document.getElementById('collabUrl');
        const shareArea = document.getElementById('share-area');
        if(collabInput) collabInput.value = window.location.href;
        if(shareArea) shareArea.style.display = 'block';

        // UI Feedback
        const toggleBtn = document.getElementById('collabToggleBtn');
        if (toggleBtn) {
            toggleBtn.innerText = "Live Session Active";
            toggleBtn.style.background = "#10b981"; // Green
        }
        
        // Connect the editors
        startLiveSync(roomId);

    } catch (error) {
        console.error("Critical Error in Collab Mode:", error);
    }
}


function startLiveSync(roomId) {
    if (!roomId) return;
    isCollaborating = true;
    const editor = document.getElementById('studentEditor');
    const status = document.getElementById('partner-status');

    if (!editor) return;

    const docRef = db.collection("collab_notes").doc(roomId);

    // 1. LISTEN for changes
    docRef.onSnapshot((doc) => {
        if (doc.exists) {
            const data = doc.data();
            
            // Only update if someone else typed it
            if (data.lastEditedBy !== currentUser.uid) {
                // Only update if the content is actually different
                if (editor.innerHTML !== data.content) {
                    
                    // --- ADVANCED CURSOR HANDLING ---
                    const selection = window.getSelection();
                    let savedOffset = 0;
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        // Simple offset check (works best for plain text or simple HTML)
                        savedOffset = range.startOffset;
                    }

                    // Update the UI
                    editor.innerHTML = data.content;
                    
                    // Update Status
                    if (status) {
                        status.innerText = `${data.lastEditedName || "Partner"} is typing...`;
                        status.style.color = "#f59e0b"; 
                        clearTimeout(window.partnerTimeout);
                        window.partnerTimeout = setTimeout(() => {
                            status.innerText = "Connected";
                            status.style.color = "#10b981";
                        }, 2000);
                    }
                }
            }
        }
    });

    // 2. SEND changes
    editor.addEventListener('input', () => {
        if (!currentUser) return;
        
        if (status) {
            status.innerText = "Syncing...";
            status.style.color = "#3b82f6";
        }

        clearTimeout(window.syncTimeout);
        window.syncTimeout = setTimeout(() => {
            docRef.set({
                content: editor.innerHTML,
                lastEditedBy: currentUser.uid,
                lastEditedName: currentUser.displayName || "Partner",
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true }).then(() => {
                if (status) {
                    status.innerText = "Connected";
                    status.style.color = "#10b981";
                }
            });
        }, 500); 
    });
}













// 1. WhatsApp Sharing
function shareToWhatsApp() {
    const url = document.getElementById('collabUrl').value;
    const text = encodeURIComponent("Hey! Join my EduFlow Live session so we can write on the same paper together: " + url);
    window.open(`https://wa.me/?text=${text}`, '_blank');
}

// 2. Email Sharing
function shareToEmail() {
    const url = document.getElementById('collabUrl').value;
    const subject = encodeURIComponent("Join my EduFlow Live Writing Session");
    const body = encodeURIComponent("I'm using the EduFlow Pro Teaching Board. Join me here to collaborate: " + url);
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
}

// 3. Native Phone Share (Triggers the phone's built-in menu)
async function shareNative() {
    const shareData = {
        title: 'EduFlow Live Collaboration',
        text: 'Join my live writing session on the Teaching Board!',
        url: document.getElementById('collabUrl').value
    };

    try {
        if (navigator.share) {
            await navigator.share(shareData);
        } else {
            alert("Native sharing not supported on this browser. Use Copy or WhatsApp instead!");
        }
    } catch (err) {
        console.log("Share cancelled or failed", err);
    }
}

// Updated Copy function with visual feedback
function copyCollabLink() {
    const copyText = document.getElementById("collabUrl");
    copyText.select();
    navigator.clipboard.writeText(copyText.value);
    
    // Change button text temporarily
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
    setTimeout(() => btn.innerHTML = originalText, 2000);
}



function toggleFocusMode() {
    const body = document.body;
    const isFocusing = body.classList.toggle('focus-active');
    const exitBtn = document.getElementById('exitFocusBtn');
    
    if (isFocusing) {
        showToast("Focus Mode Enabled ‚úçÔ∏è");
        exitBtn.style.display = 'block';
    } else {
        exitBtn.style.display = 'none';
        showToast("Focus Mode Disabled");
    }
}


let autoSaveTimeout;
let lastSavedContent = "";

// Monitor the editor for typing
document.getElementById('studentEditor').addEventListener('input', () => {
    // 1. Show "Typing" status
    const status = document.getElementById('autosave-status');
    if (status) status.innerHTML = '<i class="fas fa-pencil-alt"></i> Typing...';

    // 2. Clear previous timer and set a new one (Debounce)
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(autoSaveSync, 1000); // Try to save 3 seconds after typing stops
});

async function autoSaveSync() {
    const nameInput = document.getElementById('studentNameInput');
    const editor = document.getElementById('studentEditor');
    const status = document.getElementById('autosave-status');

    if (!nameInput || !editor) return;

    const studentName = nameInput.value.trim();
    const studentContent = editor.innerHTML;

    // 1. Don't save if name is empty
    if (!studentName) {
        if (status) status.innerHTML = '<i class="fas fa-user-slash"></i> Enter Name to Sync';
        return;
    }

    // 2. Don't save if nothing changed
    if (studentContent === lastSavedContent) {
        if (status) status.innerHTML = '<i class="fas fa-cloud"></i> Synced';
        return;
    }

    try {
        if (status) status.innerHTML = '<i class="fas fa-sync fa-spin"></i> Saving...';

        // Use .set with {merge: true} to handle both new and existing docs
        await db.collection("edu_logs").doc(studentName).set({
            studentName: studentName,
            data: studentContent,
            lastUpdated: Date.now(),
            totalActiveTime: formatTime(activeSeconds) // From our previous timer logic
        }, { merge: true });

        lastSavedContent = studentContent;
        if (status) status.innerHTML = '<i class="fas fa-check-circle" style="color:#10b981;"></i> Auto-saved';
        
        // Return to "Synced" after 2 seconds
        setTimeout(() => {
            if (status) status.innerHTML = '<i class="fas fa-cloud"></i> Synced';
        }, 2000);

    } catch (error) {
        console.error("Autosave Error:", error);
        if (status) status.innerHTML = '<i class="fas fa-wifi"></i> Sync Pending...';
    }
}




// --- SHAPE DRAWING ENGINE ---
let isStudentDrawing = false;
let studentDrawActive = false;
let drawStartTime = 0;
let drawInterval;

const sCanvas = document.getElementById('studentShapeCanvas');
const dTimer = document.getElementById('draw-timer');
const sEditor = document.getElementById('studentEditor');

function toggleStudentDrawMode() {
    studentDrawActive = !studentDrawActive;
    const btn = document.getElementById('studentShapeBtn');
    
    if (studentDrawActive) {
        btn.style.background = "#dc2626";
        btn.innerHTML = '<i class="fas fa-check"></i> Finish Shape';
        
        // Sync Canvas size to Paper size
        sCanvas.width = sEditor.offsetWidth;
        sCanvas.height = sEditor.scrollHeight;
        
        sCanvas.style.pointerEvents = "auto";
        sEditor.setAttribute('contenteditable', 'false');
    } else {
        btn.style.background = "#f87171";
        btn.innerHTML = '<i class="fas fa-draw-polygon"></i> Draw Shape';
        sCanvas.style.pointerEvents = "none";
        sEditor.setAttribute('contenteditable', 'true');
    }
}

function clearAllShapes() {
    const ctx = sCanvas.getContext('2d');
    ctx.clearRect(0, 0, sCanvas.width, sCanvas.height);
}

// Coordinate detection
function getCoords(e) {
    const rect = sCanvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return {
        x: clientX - rect.left,
        y: clientY - rect.top,
        rawX: clientX,
        rawY: clientY
    };
}

sCanvas.addEventListener('mousedown', startDrawing);
sCanvas.addEventListener('touchstart', startDrawing, {passive: false});

function startDrawing(e) {
    if(!studentDrawActive) return;
    isStudentDrawing = true;
    drawStartTime = Date.now();
    
    const pos = getCoords(e);
    const ctx = sCanvas.getContext('2d');
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
    ctx.strokeStyle = "red"; // Only Red
    ctx.lineWidth = 3;
    ctx.lineCap = "round";

    dTimer.style.display = 'block';
    updateTimer(pos.rawX, pos.rawY);
    drawInterval = setInterval(() => {
        dTimer.innerText = ((Date.now() - drawStartTime)/1000).toFixed(1) + "s";
    }, 100);
}

sCanvas.addEventListener('mousemove', moveDrawing);
sCanvas.addEventListener('touchmove', moveDrawing, {passive: false});

function moveDrawing(e) {
    if(!isStudentDrawing) return;
    if(e.cancelable) e.preventDefault();
    
    const pos = getCoords(e);
    const ctx = sCanvas.getContext('2d');
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    updateTimer(pos.rawX, pos.rawY);
}

window.addEventListener('mouseup', stopDrawing);
window.addEventListener('touchend', stopDrawing);

function stopDrawing() {
    if(isStudentDrawing) {
        isStudentDrawing = false;
        clearInterval(drawInterval);
        dTimer.style.display = 'none';
        if(typeof autoSaveSync === "function") autoSaveSync();
    }
}

function updateTimer(x, y) {
    dTimer.style.left = (x + 15) + "px";
    dTimer.style.top = (y + 15) + "px";
}



async function uploadVideo() {
    const file = document.getElementById('videoFile').files[0];
    const uploadBtn = document.getElementById('uploadBtn');
    const progressContainer = document.getElementById('upload-progress-container');
    const progressBar = document.getElementById('upload-progress-bar');

    if (!file) {
        alert("Please select a video file first!");
        return;
    }

    // 1. Create a reference in Firebase Storage
    const storageRef = firebase.storage().ref('lesson_videos/' + file.name);
    const uploadTask = storageRef.put(file);

    uploadBtn.disabled = true;
    progressContainer.style.display = 'block';

    // 2. Monitor Progress
    uploadTask.on('state_changed', 
        (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            progressBar.style.width = progress + '%';
        }, 
        (error) => {
            console.error("Upload failed:", error);
            alert("Upload failed. Make sure Firebase Storage is enabled.");
        }, 
        async () => {
            // 3. Upload Complete - Get Download URL
            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
            
            // 4. Save the Video Link to Firestore for students to see
            await db.collection("lesson_resources").add({
                type: "video",
                url: downloadURL,
                fileName: file.name,
                uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            alert("Video Uploaded Successfully! ‚úÖ");
            uploadBtn.disabled = false;
            progressContainer.style.display = 'none';
            progressBar.style.width = '0%';
        }
    );
}




async function uploadStudentPdf() {
    const file = document.getElementById('studentPdfInp').files[0];
    const nameInput = document.getElementById('studentNameInput').value.trim();

    if (!nameInput) {
        alert("Please enter your name first!");
        // Clear the file input so they can try again after entering name
        document.getElementById('studentPdfInp').value = '';
        return;
    }

    if (!file) return;

    showToast("Uploading PDF...");

    try {
        // 1. Create unique path in Storage
        const storageRef = firebase.storage().ref(`student_pdfs/${Date.now()}_${file.name}`);
        
        // 2. Upload the file
        const uploadTask = await storageRef.put(file);
        const downloadURL = await uploadTask.ref.getDownloadURL();

        // 3. Create a record in Firestore (just like a normal save)
        await db.collection("edu_logs").add({
            studentName: nameInput,
            data: `<div style="background:#fee2e2; border:2px solid #ef4444; padding:15px; border-radius:10px; text-align:center;">
                    <i class="fas fa-file-pdf" style="font-size:24px; color:#ef4444;"></i><br>
                    <strong>PDF Document Attached</strong><br>
                    <a href="${downloadURL}" target="_blank" style="color:#2563eb; text-decoration:underline;">Click here to open PDF</a>
                   </div>`,
            type: "pdf_upload",
            fileUrl: downloadURL,
            timestamp: Date.now(),
            dateString: new Date().toLocaleString()
        });

        showToast("PDF Saved to Admin Panel! ‚úÖ");
    } catch (error) {
        console.error("PDF Upload Error:", error);
        showToast("Failed to upload PDF.");
    }
}



window.addEventListener('load', () => {
    const urlParams = new URLSearchParams(window.location.search);
    
    // CHANGE THIS LINE: Look for 'portfolio' instead of 'id'
    const sharedId = urlParams.get('portfolio'); 

    if (sharedId) {
        console.log("Found Shared Portfolio ID:", sharedId);
        
        // Hide other sections
        document.querySelectorAll('.view-div').forEach(div => {
            div.style.setProperty("display", "none", "important");
            div.classList.add('hidden');
        });

        const singleView = document.getElementById('section-single-view');
        if (singleView) {
            singleView.classList.remove('hidden');
            singleView.style.setProperty("display", "block", "important");
            
            // Call your function with the 'Rules' ID
            loadSingleSharedRecord(sharedId);
        }
    }
});



const EDU_DICTIONARY = {
    positive: [
        'excellent', 'great', 'improved', 'happy', 'focused', 'success', 'amazing', 'brilliant', 'proud', 'achieved', 'perfect', 'creative', 'participated', 'confident', 'solved', 'correct', 'leadership', 'fast', 'smoothly', 'interested', 'engaged', 'mastered', 'progressing', 'wonderful', 'kind', 'polite', 'sharing', 'helpful', 'determined', 'focused', 'bright', 'cheerful', 'diligent', 'eager', 'energetic', 'friendly', 'generous', 'honest', 'imaginative', 'intelligent', 'joyful', 'knowledgeable', 'loyal', 'motivated', 'noble', 'observant', 'patient', 'quick', 'reliable', 'sincere', 'thoughtful', 'understanding', 'vibrant', 'wise', 'zealous', 'ambitious', 'brave', 'calm', 'delightful', 'enthusiastic', 'flexible', 'graceful', 'harmonious', 'inventive', 'keen', 'lively', 'modest', 'nice', 'optimistic', 'passionate', 'resourceful', 'strong', 'trustworthy', 'unique', 'valuable', 'warm', 'skilled', 'talented', 'organized', 'efficient', 'proactive', 'resilient', 'adaptable', 'articulate', 'balanced', 'capable', 'cooperative', 'curious', 'dedicated', 'empathetic', 'fearless', 'genuine', 'humble', 'independent', 'logical', 'mature', 'nurturing', 'objective', 'persistent', 'rational', 'sensible', 'tolerant', 'upbeat', 'versatile', 'witty', 'admirable', 'bold', 'charitable', 'dynamic', 'earnest', 'fearless', 'gifted', 'honorable', 'insightful', 'judicious', 'kindhearted', 'lucid', 'methodical', 'neat', 'orderly', 'precise', 'refined', 'steadfast', 'thorough', 'unselfish', 'vigilant', 'wholesome', 'astute', 'bountiful', 'cordial', 'discerning', 'exemplary', 'fruitful', 'gracious', 'hearty', 'industrious', 'jovial', 'laudable', 'mighty', 'noteworthy', 'outstanding', 'praiseworthy', 'remarkable', 'superb', 'terrific', 'unwavering', 'vivid', 'worthy', 'adept', 'blessed', 'clever', 'dashing', 'elated', 'fine', 'grand', 'handy', 'ideal', 'just', 'keen', 'lovely', 'merry', 'noble', 'open', 'pleasant', 'quiet', 'rich', 'smart', 'tidy', 'useful', 'vocal', 'worthy', 'youthful', 'zestful', 'academic', 'advanced', 'analytical', 'attentive', 'collaborative', 'comprehensive', 'decisive', 'effective', 'fluent', 'goal-oriented', 'high-achieving', 'inquisitive', 'literate', 'mathematical', 'original', 'perceptive', 'proficient', 'reflective', 'scholarly', 'strategic', 'tenacious', 'visionary'
    ],
    negative: [
        'struggled', 'difficult', 'upset', 'tired', 'distracted', 'hard', 'slow', 'confused', 'refused', 'forgot', 'unfinished', 'sad', 'angry', 'noisy', 'messy', 'frustrated', 'crying', 'failed', 'mistake', 'poor', 'bored', 'unfocused', 'off-task', 'ignored', 'slowly', 'late', 'incomplete', 'aggressive', 'anxious', 'clumsy', 'defiant', 'disobedient', 'fidgety', 'gloomy', 'hostile', 'impatient', 'irritable', 'lazy', 'mean', 'nervous', 'obstructive', 'passive', 'quarrelsome', 'rude', 'selfish', 'stubborn', 'uncooperative', 'vague', 'weak', 'worried', 'argumentative', 'bitter', 'careless', 'disorganized', 'envious', 'forgetful', 'greedy', 'harsh', 'impulsive', 'jealous', 'lonely', 'malicious', 'neglectful', 'overwhelmed', 'pessimistic', 'resentful', 'sloppy', 'tense', 'unreliable', 'vengeful', 'weary', 'withdrawn', 'apathetic', 'belligerent', 'cynical', 'disrespectful', 'erratic', 'frail', 'grumpy', 'hasty', 'insecure', 'judgmental', 'lethargic', 'moody', 'negative', 'opinionated', 'prejudiced', 'reckless', 'spiteful', 'unstable', 'vulnerable', 'wicked', 'anxiety', 'bullying', 'conflict', 'depression', 'disruption', 'exclusion', 'failure', 'guilt', 'hatred', 'isolation', 'jealousy', 'misbehavior', 'neglect', 'outburst', 'pain', 'rejection', 'shame', 'stress', 'trauma', 'unrest', 'violence', 'absent', 'awkward', 'broken', 'damaged', 'empty', 'faulty', 'gross', 'harmful', 'injured', 'junk', 'lost', 'nasty', 'odd', 'painful', 'rotten', 'scary', 'terrible', 'ugly', 'vile', 'waste', 'zero', 'bad', 'cheap', 'dirty', 'evil', 'foul', 'grim', 'hard', 'ill', 'jaded', 'killer', 'low', 'mad', 'numb', 'off', 'pest', 'quit', 'rank', 'sour', 'tart', 'under', 'vice', 'wild', 'yell', 'abrupt', 'avoidant', 'cluttered', 'disconnected', 'exhausted', 'fretful', 'guarded', 'hesitant', 'inhibited', 'lackluster', 'muddled', 'non-compliant', 'over-sensitive', 'provocative', 'resistant', 'stagnant', 'unresponsive', 'vacant', 'wearisome'
    ],
    natural: [
        'steady', 'completed', 'normal', 'working', 'okay', 'standard', 'average', 'typical', 'continued', 'expected', 'routine', 'finished', 'followed', 'observed', 'noted', 'plain', 'regular', 'satisfactory', 'usual', 'common', 'customary', 'daily', 'general', 'moderate', 'natural', 'ordinary', 'stable', 'uniform', 'basic', 'central', 'constant', 'direct', 'even', 'fixed', 'generic', 'habitual', 'internal', 'level', 'neutral', 'objective', 'passive', 'quiet', 'simple', 'traditional', 'universal', 'valid', 'weekly', 'yearly', 'actual', 'brief', 'current', 'defined', 'existing', 'formal', 'global', 'historical', 'initial', 'joint', 'known', 'local', 'main', 'nominal', 'overall', 'prior', 'quick', 'recent', 'specific', 'total', 'underlying', 'virtual', 'whole', 'base', 'core', 'data', 'element', 'fact', 'grid', 'item', 'key', 'list', 'mark', 'node', 'part', 'range', 'site', 'task', 'unit', 'view', 'word', 'area', 'block', 'case', 'desk', 'entry', 'file', 'group', 'hall', 'index', 'job', 'kit', 'link', 'mode', 'name', 'output', 'page', 'query', 'row', 'step', 'term', 'user', 'value', 'zone', 'attendance', 'background', 'calendar', 'document', 'environment', 'form', 'grade', 'history', 'information', 'journal', 'level', 'manual', 'notice', 'observation', 'profile', 'report', 'schedule', 'table', 'update', 'version', 'waiting', 'account', 'balance', 'category', 'detail', 'example', 'folder', 'guide', 'header', 'input', 'label', 'method', 'number', 'object', 'process', 'result', 'status', 'topic', 'utility', 'volume', 'weight', 'abstract', 'binary', 'code', 'default', 'engine', 'format', 'graph', 'host', 'image', 'layout', 'module', 'network', 'option', 'path', 'resource', 'source', 'type', 'unique', 'vector', 'window', 'array', 'buffer', 'client', 'device', 'event', 'field', 'handle', 'interface', 'library', 'memory', 'object', 'parameter', 'record', 'server', 'template', 'upload'
    ]
};






// 1. The Analysis Engine
// Pre-convert arrays to Sets for speed (Run this once)
const posSet = new Set(EDU_DICTIONARY.positive);
const negSet = new Set(EDU_DICTIONARY.negative);
const neuSet = new Set(EDU_DICTIONARY.natural);

function analyzeSentiment(text) {
    if (!text) return { emoji: 'üòê', color: '#94a3b8' };
    
    // Clean text: remove punctuation and split into lowercase words
    const words = text.toLowerCase().replace(/[.,!?;:()]/g, "").split(/\s+/);
    
    let posScore = 0;
    let negScore = 0;
    let neuScore = 0;

    words.forEach(word => {
        if (posSet.has(word)) posScore++;
        else if (negSet.has(word)) negScore++;
        else if (neuSet.has(word)) neuScore++;
    });

    // Weighted decision
    if (posScore > negScore) {
        return { emoji: 'üåü', color: '#10b981' }; // Positive
    } else if (negScore > posScore) {
        return { emoji: 'üòü', color: '#ef4444' }; // Negative
    } else {
        return { emoji: 'üòê', color: '#6366f1' }; // Neutral
    }
}


function downloadAsPDF(studentName) {
    // The element we want to turn into a PDF
    const element = document.querySelector('[style*="background:white"]'); 
    
    // Optional: Hide the "Return Home" and "Download" buttons temporarily in the PDF
    const options = {
        margin:       10,
        filename:     `${studentName}_Record.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { 
            scale: 2, 
            useCORS: true, // Important for loading the shapes from Firebase
            letterRendering: true 
        },
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    showToast("Generating PDF...");

    // Run the conversion
    html2pdf().set(options).from(element).save().then(() => {
        showToast("‚úÖ PDF Downloaded!");
    });
}



function updateUserStatus(user) {
    const statusRef = db.collection("status").doc(user.uid);
    
    // Set status to online
    statusRef.set({
        name: user.displayName,
        id: user.uid,
        status: "online",
        last_changed: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Listen for all users
    db.collection("status").onSnapshot((snapshot) => {
        const userList = document.getElementById('user-list');
        userList.innerHTML = "";
        
        snapshot.forEach((doc) => {
            const data = doc.data();
            if (data.id === user.uid) return; // Skip yourself

            const userRow = document.createElement('div');
            userRow.style = "display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #f1f5f9; align-items:center;";
            userRow.innerHTML = `
                <span style="font-size:13px; font-weight:500;">
                    <span style="color:#10b981;">‚óè</span> ${data.name} 
                    <small style="color:#64748b;">(ID: ${data.id.substring(0,5)})</small>
                </span>
                <button onclick="sendInvite('${data.id}', '${data.name}')" style="background:#6366f1; color:white; border:none; padding:4px 8px; border-radius:5px; font-size:11px; cursor:pointer;">Invite</button>
            `;
            userList.appendChild(userRow);
        });
    });

    // Listen for private invites sent TO ME
    db.collection("invites").doc(user.uid).onSnapshot((doc) => {
        if (doc.exists && doc.data().status === "pending") {
            const invite = doc.data();
            showInviteModal(invite);
        }
    });
}





// Start Presence with Name and Subject
function startPresence(user, subject) {
    const statusRef = db.collection("status").doc(user.uid);
    
    statusRef.set({
        name: user.displayName || "Unknown Student",
        subject: subject || "General Study",
        id: user.uid,
        lastActive: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Watch for other students
    db.collection("status").onSnapshot((snapshot) => {
        const userList = document.getElementById('user-list');
        if (!userList) return;
        userList.innerHTML = "";
        let count = 0;

        snapshot.forEach((doc) => {
            const data = doc.data();
            if (data.id === user.uid) return; // Skip self

            count++;
            const userRow = document.createElement('div');
            userRow.style = "display:flex; justify-content:space-between; align-items:center; padding:12px; background:#f8fafc; border-radius:15px; border:1px solid #f1f5f9;";
            userRow.innerHTML = `
                <div>
                    <div style="font-size:13px; font-weight:700; color:#1e293b;">${data.name}</div>
                    <div style="font-size:11px; color:#6366f1; font-weight:600;">üìö ${data.subject}</div>
                </div>
                <button onclick="sendInvite('${data.id}', '${data.name}')" style="background:#6366f1; color:white; border:none; padding:8px 14px; border-radius:10px; font-size:11px; font-weight:700; cursor:pointer;">Invite</button>
            `;
            userList.appendChild(userRow);
        });
        document.getElementById('online-count').innerText = `${count} Online`;
    });
}
function listenForInvites(user) {
    if (!user) return;
    console.log("üì° Active: Listening for collaboration requests...");

    // Listen to the document named after the CURRENT user's ID
    db.collection("invites").doc(user.uid).onSnapshot((doc) => {
        if (!doc.exists) return;

        const data = doc.data();
        
        // Safety check: only trigger for "request" types
        if (data.type === "request") {
            const card = document.getElementById('invite-notification');
            const msg = document.getElementById('invite-msg');
            const acceptBtn = document.getElementById('accept-invite-btn');

            if (card && msg) {
                // 1. Play a subtle notification sound
                const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');
                audio.play().catch(() => console.log("Sound blocked by browser"));

                // 2. Populate the professional card with data
                msg.innerHTML = `
                    <span style="color:#6366f1; font-weight:800;">${data.fromName}</span> 
                    is inviting you to study: <br>
                    <i style="color:#1e293b;">"${data.fromSubject || 'General Notes'}"</i>
                `;
                
                // 3. Show the card
                card.style.display = 'block';

                // 4. Handle ACCEPT
                acceptBtn.onclick = () => {
                    console.log("‚úÖ Invite Accepted. Joining room:", data.roomId);
                    
                    // Clear the invite document immediately
                    db.collection("invites").doc(user.uid).delete();
                    
                    // Navigate to the shared room
                    const collabLink = window.location.origin + window.location.pathname + "?room=" + data.roomId;
                    window.location.href = collabLink;
                };
            }
        }
    }, (error) => {
        console.error("‚ùå Invite Listener Error:", error);
    });
}

// 5. Global Decline/Close function (Linked to your Decline button)
function closeInvite() {
    const card = document.getElementById('invite-notification');
    if (card) card.style.display = 'none';

    if (currentUser) {
        // Clear the invite from Firestore so it doesn't reappear
        db.collection("invites").doc(currentUser.uid).delete()
          .then(() => console.log("Invite declined and cleared."))
          .catch(err => console.error("Error clearing invite:", err));
    }
}
function sendInvite(targetId, targetName) {
    if (!currentUser) return alert("Please login first");

    // 1. Generate the shared Room ID
    const newRoomId = "collab-" + Math.random().toString(36).substring(2, 8);
    const mySubject = document.getElementById('subjectInput')?.value || "Shared Study";

    // 2. Send the data to the Receiver
    db.collection("invites").doc(targetId).set({
        fromName: currentUser.displayName,
        fromId: currentUser.uid,
        fromSubject: mySubject,
        roomId: newRoomId,
        type: "request"
    }).then(() => {
        // --- THE FIX: The Sender must also move to this URL ---
        const targetUrl = window.location.origin + window.location.pathname + "?room=" + newRoomId;
        window.location.href = targetUrl; 
    });
}






document.addEventListener("visibilitychange", function() {
    if (document.visibilityState === 'hidden' && currentUser) {
        // When the user minimizes the app or closes the tab
        db.collection("status").doc(currentUser.uid).delete();
    } else if (document.visibilityState === 'visible' && currentUser) {
        // When they come back to the tab, put them back online
        db.collection("status").doc(currentUser.uid).set({
            name: currentUser.displayName,
            id: currentUser.uid,
            status: "online",
            lastActive: firebase.firestore.FieldValue.serverTimestamp()
        });
    }
});





// Add this at the very bottom of your JS file
firebase.auth().onAuthStateChanged((user) => {
    if (user) {
        currentUser = user;
        listenForInvites(user); // Keep listening for new requests

        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');

        if (roomId) {
            console.log("üöÄ Auto-connecting to room:", roomId);
            startLiveSync(roomId);
            
            // Optional: If they joined via link, they might not have set a subject.
            // You can mark them online here too.
            if (typeof startPresence === "function") {
                startPresence(user, "Collaborating..."); 
            }
        }
    }
});
</script>




<div id="section-single-view" class="view-div hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 9999; overflow-y: auto; padding: 20px;">
        <div style="max-width: 800px; margin: 0 auto; display: flex; justify-content: flex-end;">
            <button onclick="location.href=window.location.pathname" style="background: rgba(255,255,255,0.1); color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer;">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
        <div id="single-view-container" style="max-width: 800px; margin: 20px auto; opacity: 0; transition: opacity 0.5s;">
        </div>
    </div>

    <div id="qrModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; justify-content:center; align-items:center;">
        <div style="background:white; padding:25px; border-radius:15px; text-align:center; min-width: 280px; box-shadow: 0 10px 25px rgba(0,0,0,0.5);">
            <h3 style="color:#1e293b; margin-bottom:15px; font-family:sans-serif;">Share Record</h3>
            <div id="qrcode" style="margin-bottom: 20px; display: flex; justify-content: center;"></div>
            <button onclick="document.getElementById('qrModal').style.display='none'" 
                    style="padding:10px 25px; background:#ef4444; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">
                Close
            </button>
        </div>
    </div>











    <div id="invite-notification" style="display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:9999; width:90%; max-width:400px; background:white; padding:20px; border-radius:16px; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); border:1px solid #e2e8f0; animation: slideDown 0.4s ease-out;">
    <div style="display:flex; align-items:center; gap:12px; margin-bottom:15px;">
        <div style="background:#e0e7ff; padding:10px; border-radius:12px;">
            <i class="fas fa-user-friends" style="color:#6366f1; font-size:20px;"></i>
        </div>
        <div>
            <h4 style="margin:0; font-size:16px; color:#1e293b;">Incoming Request</h4>
            <p id="invite-msg" style="margin:0; font-size:13px; color:#64748b;"></p>
        </div>
    </div>
    <div style="display:flex; gap:10px;">
        <button id="accept-invite-btn" style="flex:1; background:#6366f1; color:white; border:none; padding:10px; border-radius:10px; font-weight:600; cursor:pointer;">Accept</button>
        <button onclick="closeInvite()" style="flex:1; background:#f1f5f9; color:#475569; border:none; padding:10px; border-radius:10px; font-weight:600; cursor:pointer;">Decline</button>
    </div>
</div>







<style>
@keyframes slideDown {
    from { top: -100px; opacity: 0; }
    to { top: 20px; opacity: 1; }
}
</style>



    </body>
</html>
</body>
</html>







